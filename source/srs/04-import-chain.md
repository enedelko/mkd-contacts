# Цепочка импорта реестра

**Порядок: LOST-01 → BE-02 → CORE-01 → LOST-02**

---

## CORE-01 — Импорт реестра (CSV/XLS). Учёт собственников и помещений

### 1. Архитектурный анализ (CoT)
Импорт выполняется в Backend (FastAPI), данные сохраняются в PostgreSQL. Модуль логики расширяется операциями массовой вставки/обновления помещений и контактов собственников. Реализация невозможна без **LOST-01** (схема БД: помещения, контакты) и **BE-02** (шифрование ПДн). Блокер для навигации и фильтров — без реестра помещений и контактов карта и расчёт кворума не имеют данных.

### 2. Описание и цель
Инструмент загрузки реестра помещений и контактов собственников из файлов CSV/XLS. Загрузка идёт в денормализованном виде: одна строка файла = одно помещение + один контакт; на одно помещение может приходиться несколько строк (несколько контактов). Цель — наполнение БД помещениями МКД и контактами собственников для навигации и расчёта кворума.

### 3. Функциональные требования
* **SR-CORE01-001:** Система должна принимать файл загрузки через API (доступ только для авторизованного администратора).
* **SR-CORE01-002:** Система должна поддерживать формат CSV с кодировкой UTF-8.
* **SR-CORE01-003:** Система должна поддерживать формат XLS (или XLSX) для чтения листов с данными.
* **SR-CORE01-004:** Система должна извлекать из файла поля помещений: кадастровый номер (или идентификатор помещения), площадь, подъезд, этаж, тип помещения, номер помещения; и при наличии — поля контактов (см. перечень ПДн ниже).
* **SR-CORE01-005:** Система должна валидировать обязательные поля перед записью в БД.
* **SR-CORE01-006:** Система должна записывать данные в рамках транзакции: помещения — уникально по кадастровому номеру/ид; контакты — по одной записи на строку файла (связь с помещением), т.е. допускается несколько контактов на одно помещение (денормализованная загрузка).
* **SR-CORE01-007:** Система должна возвращать отчёт: количество принятых строк и список ошибок по строкам (при наличии).
* **SR-CORE01-008:** При критической ошибке формата файла система должна откатывать транзакцию и не вносить изменений.
* **SR-CORE01-009:** Номер помещения должен иметь строковый тип (String), чтобы поддерживать значения типа «9А», «IX», «10-б».
* **SR-CORE01-010:** Все ПДн, передаваемые при импорте (см. перечень ниже), должны шифроваться бэкендом (BE-02) перед записью в БД. Прямая запись открытых ПДн в БД запрещена.

### 4. Сценарий использования
**Триггер:** Администратор загружает файл реестра (помещения и контакты собственников).
**Main Success Scenario:**
1. Администратор выбирает файл CSV/XLS (денормализованный: строки «помещение + контакт») и отправляет запрос.
2. Система проверяет формат и права, парсит файл, валидирует строки, записывает помещения и контакты в БД (ПДн — в зашифрованном виде) и возвращает отчёт.
**Alternative Flows:**
* **AF-1 (Ошибка валидации):** Если часть строк невалидна, система записывает только валидные и возвращает в отчёте перечень ошибок по номерам строк.
* **AF-2 (Таймаут/недоступность БД):** При недоступности БД система возвращает HTTP 503 и не сохраняет данные.

### 5. Модель данных

**Денормализованная загрузка:** Одна строка файла соответствует одной паре «помещение + контакт». На одно помещение может приходиться несколько строк (разные контакты). При импорте система формирует/обновляет записи в таблицах **premises** (уникально по помещению) и **contacts** (одна запись на строку с контактом, связь с помещением по кадастровому номеру/ид).

**Поля помещений** (по LOST-01): кадастровый_номер (или id), площадь, подъезд, этаж, тип_помещения, номер_помещения, общая_площадь_МКД (при необходимости).

**Поля контактов** (по LOST-01): связь с помещением (premise_id), контактные данные и метаданные — см. перечень ПДн ниже. Остальные поля контакта (дата_создания, ip, статус и т.д.) задаёт бэкенд при импорте.

**ПДн, хранимые при импорте (все — только в зашифрованном виде, BE-02):**

| Категория | Поля | Обязательность |
|-----------|------|----------------|
| Контактные данные | телефон, email, telegram_id | Для строки с контактом обязательно **хотя бы одно** из трёх (остальные опциональны) |
| Обращение | как обращаться к собственнику | Опционально (например: «Иван Иванович», «г-н Петров») — ПДн |

Итого: телефон, email и telegram_id по колонкам файла — опциональны по отдельности, но для каждой строки, считающейся контактом, должна быть заполнена хотя бы одна из этих колонок. Поле «как обращаться» — полностью опционально.

### 6. Интеграции и API
* **Method:** `POST /api/admin/import/register`
* **Request:** multipart/form-data с полем `file` (CSV или XLS). Заголовок `Authorization: Bearer <JWT>`.
* **Response (успех):**
```json
{
  "accepted": 120,
  "rejected": 3,
  "errors": [
    { "row": 5, "message": "Missing required field: area" },
    { "row": 12, "message": "Invalid cadastral number format" }
  ]
}
```
* **Response (ошибка формата/отказ):**
```json
{
  "detail": "Unsupported file format or corrupted file"
}
```

### 7. Нефункциональные требования
* **Security:** Доступ только для роли администратор/суперадмин; логирование факта импорта и объёма данных (аудит).
* **Performance:** Рекомендуемый лимит размера файла (например, до 5 MB) и таймаут обработки; при больших объёмах — асинхронная задача или батчи.

---

## LOST-02 — Страница загрузки реестров (Upload Page)

### 1. Архитектурный анализ (CoT)
Страница реализуется на Frontend (React) в составе админ-интерфейса и взаимодействует с API импорта (CORE-01). Обеспечивает выбор файла с ПК и мобильных устройств, отображение инструкции по формату и валидацию структуры файла до отправки или на ответе сервера с детализацией ошибки. Связана с CORE-01.

### 2. Описание и цель
Интерфейс загрузки реестров: инструкция по форматам и колонкам, выбор файла (.xlsx, .csv), валидация набора колонок с выдачей критической ошибки и сравнением «Обнаруженные» vs «Ожидаемые» колонки. Цель — снижение ошибок импорта и соответствие ожидаемой структуре данных.

### 3. Функциональные требования
* **SR-LOST02-001:** На странице загрузки должна быть размещена инструкция по поддерживаемым форматам файлов (.xlsx, .csv) и список ожидаемых колонок с описанием.
* **SR-LOST02-002:** Система должна предоставлять возможность выбора файла с ПК (выбор через диалог файловой системы).
* **SR-LOST02-003:** Система должна предоставлять возможность выбора файла с мобильных устройств (поддержка input type file с accept и при необходимости capture для камеры/галереи по политике).
* **SR-LOST02-004:** Система должна выполнять валидацию структуры файла: если набор колонок не совпадает с ожидаемым, должна выдаваться критическая ошибка без выполнения импорта.
* **SR-LOST02-005:** Сообщение об ошибке валидации структуры должно содержать явное сравнение: «Обнаруженные колонки» и «Ожидаемые колонки» (списки названий колонок).
* **SR-LOST02-006:** Критическая ошибка структуры должна отображаться пользователю на странице (и при необходимости возвращаться в теле ответа API при проверке на бэкенде).

### 4. Сценарий использования
**Триггер:** Администратор открывает страницу загрузки реестров.
**Main Success Scenario:**
1. Администратор читает инструкцию, выбирает файл .xlsx или .csv с ожидаемым набором колонок и запускает загрузку.
2. Система проверяет структуру (на клиенте и/или сервере), выполняет импорт и отображает отчёт.
**Alternative Flows:**
* **AF-1 (Ошибка структуры):** Набор колонок не совпадает с ожидаемым — система выдаёт критическую ошибку с сравнением «Обнаруженные колонки» vs «Ожидаемые колонки»; импорт не выполняется.
* **AF-2 (Неподдерживаемый формат/повреждённый файл):** Система отображает сообщение об ошибке формата или целостности файла; импорт не выполняется.

### 5. Модель данных
Не меняется; список ожидаемых колонок — по CORE-01 (поля помещений и при наличии: телефон, email, telegram_id, как обращаться к собственнику).

### 6. Интеграции и API
* **Method:** `POST /api/admin/import/register` (как в CORE-01). При валидации структуры на бэкенде при несовпадении колонок возвращать 400 с телом:
* **Response (ошибка структуры):**
```json
{
  "detail": "Column structure mismatch",
  "expected_columns": ["cadastral_number", "area", "entrance", "floor", "premise_type", "premise_number"],
  "detected_columns": ["cadastral_number", "area", "entrance", "floor"]
}
```
Клиент отображает сравнение «Обнаруженные колонки» vs «Ожидаемые колонки» на основе полей `detected_columns` и `expected_columns`.

### 7. Нефункциональные требования
* **UX:** Инструкция должна быть видимой до выбора файла; сообщение об ошибке структуры — читаемым и без технического жаргона где возможно.
* **Accessibility:** Элемент выбора файла доступен с клавиатуры и с мобильных устройств.

**Приоритет:** Повышен в связи с блокирующей ролью загрузки реестров для навигации и аналитики; реализация в связке с CORE-01.
