# BE-01 — Инфраструктура: frontend, backend, db (SR-BE01-001)
# Перед контейнерами — Nginx на хосте (SR-BE01-006). Порты контейнеров только на localhost (SR-BE01-007).
# См. docs/deploy/01-bootstrap.md и nginx-host.example.conf
#
# ВАЖНО: Значения по умолчанию (mkd_secret и т.д.) — только для разработки.
# В production обязательно использовать .env с уникальными паролями и секретами.

services:
  db:
    image: postgres:15-alpine
    container_name: mkd-db
    environment:
      TZ: Europe/Moscow
      PGTZ: Europe/Moscow  # Специальная переменная для PostgreSQL
      POSTGRES_USER: ${POSTGRES_USER:-mkd}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mkd_secret}
      POSTGRES_DB: ${POSTGRES_DB:-mkd_contacts}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mkd} -d ${POSTGRES_DB:-mkd_contacts}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mkd-backend
    env_file: .env
    environment:
      TZ: Europe/Moscow
      DATABASE_URL: postgresql://${POSTGRES_USER:-mkd}:${POSTGRES_PASSWORD:-mkd_secret}@db:5432/${POSTGRES_DB:-mkd_contacts}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      JWT_SECRET: ${JWT_SECRET:-}
      BLIND_INDEX_PEPPER: ${BLIND_INDEX_PEPPER:-}
      MASTER_KEY_PATH: ${MASTER_KEY_PATH:-}
    ports:
      - "127.0.0.1:8000:8000"
    depends_on:
      db:
        condition: service_healthy
    # Мастер-ключ шифрования (BE-02) НЕ в репозитории. Варианты:
    # 1) Docker Secrets: secrets: [encryption_key]; в swarm.
    # 2) Bind mount: volumes: ["/host/path/to/encryption.key:/app/encryption.key:ro"]
    # Контейнер db не имеет доступа к этому секрету.
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_TELEGRAM_BOT_USERNAME: ${VITE_TELEGRAM_BOT_USERNAME:-}
    container_name: mkd-frontend
    environment:
      TZ: Europe/Moscow
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  pgdata:
    # Персистентные данные PostgreSQL (SR-BE01-002)
