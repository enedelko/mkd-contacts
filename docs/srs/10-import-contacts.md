# Загрузка контактов (только контакты)

**Порядок: CORE-01, LOST-02 → ADM-06, ADM-07, ADM-08**

Фича даёт обычным администраторам возможность загружать контакты по уже существующим помещениям без права создавать или изменять реестр помещений (полный реестр — только суперадмин, см. CORE-01).

---

## ADM-06 — Импорт только контактов (CSV/XLS/XLSX)

### 1. Архитектурный анализ (CoT)

Импорт контактов выполняется в Backend (FastAPI), данные сохраняются в PostgreSQL. Используются те же механизмы, что и в CORE-01: парсинг файлов, маппинг колонок по алиасам, шифрование ПДн (BE-02), Blind Index для сопоставления контактов. **Отличие от CORE-01:** помещения не создаются и не обновляются; допустимы только строки, у которых помещение с указанным кадастровым номером уже есть в БД. Доступ — у любого авторизованного администратора (не только суперадмин). Зависимости: LOST-01 (схема БД), BE-02 (шифрование), ADM-01 (авторизация админа).

### 2. Описание и цель

Инструмент загрузки **только контактов** из файлов CSV/XLS/XLSX. Одна строка файла = один контакт по помещению с известным кадастровым номером. Цель — дать администраторам МКД удобный способ массово добавлять или обогащать контакты собственников без доступа к полному импорту реестра (создание/изменение помещений остаётся за суперадмином).

### 3. Функциональные требования

* **SR-ADM06-001:** Система должна принимать файл загрузки контактов через отдельный API (доступ для любого авторизованного администратора).
* **SR-ADM06-002:** Система должна поддерживать форматы CSV (UTF-8), XLS и XLSX в соответствии с CORE-01.
* **SR-ADM06-003:** Обязательными для файла являются: колонка кадастрового номера (или её алиас по CORE-01) и хотя бы одна из колонок: телефон, email, telegram_id. При отсутствии кадастрового номера или всех контактных колонок система должна возвращать ошибку структуры (400) с указанием ожидаемых колонок.
* **SR-ADM06-004:** Система должна обрабатывать только строки, в которых помещение с указанным кадастровым номером **уже существует** в таблице premises. Строки с неизвестным кадастровым номером не импортируются; в отчёт включается ошибка по номеру строки (например, «Premise not found»).
* **SR-ADM06-005:** Для каждой валидной строки (кадастр найден, есть хотя бы одно контактное поле) система применяет те же правила, что и CORE-01: создание нового контакта (статус PENDING), обогащение существующего по Blind Index (SR-CORE01-013, SR-CORE01-014), защита уже заполненных полей (SR-CORE01-015), отказ при коллизии (SR-CORE01-016). ПДн шифруются (BE-02).
* **SR-ADM06-006:** Система должна возвращать отчёт в том же формате, что и CORE-01: количество принятых и отклонённых строк, список ошибок по номерам строк с кратким сообщением.
* **SR-ADM06-007:** При критической ошибке (формат файла, недоступность БД) система откатывает транзакцию и не вносит изменений; при частичной ошибке по строкам — записывает только валидные и возвращает ошибки по строкам в отчёте.
* **SR-ADM06-008:** Система должна позволять загружать опциональные поля при наличии соответствующих колонок в файле: **собственник/житель** (is_owner: true — собственник, false — проживающий), **обращение** (how_to_address), **вопросы по ОСС** (позиция по шлагбаумам — barrier_vote: for | against | undecided; формат голосования — vote_format: electronic | paper | undecided). При отсутствии колонки или пустом значении в строке соответствующее поле контакта или записи голосования_в_ОСС не изменяется (при создании контакта — значения по умолчанию по LOST-01). Правила обогащения (SR-CORE01-014, SR-CORE01-015) применяются и к опциональным полям: пустое в файле не затирает существующее в БД.

### 4. Сценарий использования

**Триггер:** Администратор загружает файл с контактами (кадастровый номер + контактные данные).

**Main Success Scenario:**
1. Администратор выбирает файл CSV/XLS/XLSX с колонками кадастровый номер и хотя бы одной контактной колонкой и отправляет запрос на импорт контактов.
2. Система проверяет права, парсит файл, проверяет наличие обязательных колонок; для каждой строки проверяет существование помещения по кадастру; для существующих помещений применяет правила CORE-01 по контактам; записывает валидные данные в БД и возвращает отчёт (accepted, rejected, errors по строкам).

**Alternative Flows:**
* **AF-1 (Нет обязательных колонок):** Система возвращает 400 с expected_columns и detected_columns; импорт не выполняется.
* **AF-2 (Помещение не найдено):** Строка отклоняется, в отчёт добавляется ошибка с номером строки и сообщением о том, что помещение не найдено.
* **AF-3 (Коллизия/ошибка по строке):** Строка не импортируется, причина указывается в отчёте (как в CORE-01).

### 5. Модель данных

Не меняется. Используются таблицы **premises** (только чтение по cadastral_number), **contacts** (вставка/обновление) и при наличии данных по ОСС — **голосование_в_ОСС** (oss_voting). Поля контактов и правила сопоставления — по CORE-01 (phone, email, telegram_id, how_to_address; Blind Index; шифрование).

**Обязательные колонки файла (минимум):** cadastral_number (или алиас), phone | email | telegram_id (хотя бы один).

**Опциональные колонки (при наличии в файле — импортируются):** how_to_address (обращение), is_owner (собственник/житель: true/false или эквивалент), barrier_vote (позиция по шлагбаумам: for | against | undecided), vote_format (формат голосования: electronic | paper | undecided). Колонки помещений (area, entrance, floor и т.д.) в этом импорте не используются.

**Алиасы колонок и значений (русский язык).** По согласованию с CORE-01 система должна распознавать в заголовках файла русские названия колонок и в ячейках — русские значения (приведённые к каноническому виду при импорте).

*Алиасы заголовков колонок (релевантные для загрузки контактов):*

| Каноническое имя | Допустимые алиасы (в т.ч. русские) |
|------------------|-------------------------------------|
| cadastral_number | кадастровый_номер, кадастровый номер |
| phone | телефон, тел |
| email | почта, e-mail |
| telegram_id | тг, telegram |
| how_to_address | как_обращаться, обращение, как обращаться |
| is_owner | собственник, Собственник?, проживающий |
| barrier_vote | позиция_по_шлагбаумам, позиция по шлагбаумам |
| vote_format | формат_голосования, формат голосования |

*Алиасы значений (булево и перечисления):*

| Поле | Каноническое значение | Допустимые алиасы в файле |
|------|------------------------|---------------------------|
| is_owner | true | Да, 1, yes, true |
| is_owner | false | Нет, 0, no, false |
| barrier_vote | for | ЗА, за, да |
| barrier_vote | against | ПРОТИВ, против, нет |
| barrier_vote | undecided | не определён, не определен; воздержался, воздержалась, воздержались; пока не решил, пока не решила, пока не решили; пока не определились; думают |
| vote_format | electronic | электронно, электронный |
| vote_format | paper | бумага, бумажный, на бумаге |
| vote_format | undecided | пока не решили, пока не определились, думают |

### 6. Интеграции и API

* **Method:** `POST /api/admin/import/contacts`
* **Request:** multipart/form-data с полем `file`. Заголовок `Authorization: Bearer <JWT>`. Доступ — любой роль administrator или super_administrator.
* **Response (успех):** тот же формат, что и у CORE-01:
```json
{
  "accepted": 45,
  "rejected": 2,
  "errors": [
    { "row": 3, "message": "Premise not found: 77:02:0015008:9999" },
    { "row": 7, "message": "Collision: phone matches existing contact, email contradicts" }
  ]
}
```
* **Response (ошибка структуры, 400):**
```json
{
  "detail": "At least one contact column required: phone, email, or telegram_id",
  "expected_columns": ["cadastral_number", "phone", "email", "telegram_id", "how_to_address", "is_owner", "barrier_vote", "vote_format"],
  "detected_columns": ["cadastral_number", "area"]
}
```

### 7. Нефункциональные требования

* **Security:** Доступ только для авторизованного администратора (ADM-01); логирование факта импорта и объёма (аудит). Полный реестр (создание/изменение помещений) остаётся только у суперадмина.
* **Performance:** Рекомендуемый лимит размера файла тот же, что и для CORE-01 (например, до 5 MB).

---

## ADM-07 — Интерфейс загрузки контактов

### 1. Архитектурный анализ (CoT)

Реализуется на Frontend (React) в составе страницы загрузки (LOST-02) или отдельным блоком на той же странице. Взаимодействует с `POST /api/admin/import/contacts`. Для суперадмина на странице отображаются оба варианта загрузки (реестр и контакты); для обычного администратора — только загрузка контактов, чтобы не показывать недоступный функционал реестра.

### 2. Описание и цель

Удобный интерфейс выбора файла и загрузки контактов: инструкция по формату и обязательным колонкам, выбор файла, отображение отчёта (принято/отклонено, ошибки по строкам). Цель — снижение ошибок и понятные подсказки для администратора.

### 3. Функциональные требования

* **SR-ADM07-001:** Система должна отображать блок «Загрузка контактов» с инструкцией: поддерживаемые форматы (.csv, .xlsx, .xls), обязательные колонки (кадастровый номер и хотя бы одна из: phone, email, telegram_id), опциональные колонки (обращение, собственник/житель, вопросы по ОСС: позиция по шлагбаумам, формат голосования), пояснение, что помещения должны уже быть в реестре.
* **SR-ADM07-002:** Для роли super_administrator на странице загрузки должны быть доступны оба блока: загрузка реестра (помещения + контакты) и загрузка контактов. Для роли administrator — только блок загрузки контактов (блок реестра скрыт или не отображается).
* **SR-ADM07-003:** Элемент выбора файла и кнопка отправки должны быть доступны с клавиатуры и с мобильных устройств (аналогично LOST-02).
* **SR-ADM07-004:** При ошибке структуры (400 с expected_columns/detected_columns) система должна отображать сравнение «Обнаруженные колонки» и «Ожидаемые колонки» (аналогично LOST-02 SR-LOST02-005).
* **SR-ADM07-005:** После успешной загрузки система должна отображать отчёт: количество принятых и отклонённых строк, при наличии — раскрываемый список ошибок по номерам строк.

### 4. Сценарий использования

**Триггер:** Администратор открывает страницу загрузки и выбирает загрузку контактов.

**Main Success Scenario:**
1. Администратор видит инструкцию по загрузке контактов, выбирает файл с нужными колонками и нажимает отправку.
2. Система отправляет файл на API, получает отчёт и отображает результат (accepted, rejected, список ошибок при необходимости).

**Alternative Flows:** Ошибка структуры — отображение сравнения колонок; 403 при попытке загрузки реестра обычным админом — не возникает, так как блок реестра скрыт.

### 5. Связь с другими модулями

| Модуль | Связь |
|--------|--------|
| CORE-01 | Общие правила парсинга, алиасы колонок, шифрование, Blind Index, обогащение и коллизии контактов |
| LOST-02 | Общая страница загрузки; для суперадмина — два блока (реестр + контакты) |
| BE-02, ADM-01 | Шифрование ПДн; доступ только для админа |

---

## ADM-08 — Формирование шаблона контактов по подъезду

### 1. Архитектурный анализ (CoT)

Формирование шаблона выполняется на Backend по запросу администратора: выбор подъезда (entrance), выборка всех помещений этого подъезда из premises, подстановка известных контактов (из contacts и при необходимости oss_voting), выдача файла XLSX для последующего заполнения и загрузки через ADM-06. Зависимости: LOST-01 (premises, contacts), BE-02 (расшифровка ПДн только для выдачи в шаблон админу), BE-03 (аудит-лог). Доступ — любой авторизованный администратор.

### 2. Описание и цель

Администратор выбирает подъезд; система формирует файл-шаблон XLSX, в котором по одной строке на каждый контакт: для каждого помещения выбранного подъезда выводятся все его контакты (если контактов несколько — добавляются строки для каждого контакта). Строки упорядочены по помещению (тип помещения, затем номер помещения — естественная сортировка, как в списке контактов CORE-03). В таблицу выводятся: кадастровый номер, тип помещения, номер помещения, колонка «ТГ» (гиперссылка в Telegram по telegram_id или по номеру телефона — та же логика, что в списке контактов), а также все известные контактные данные (телефон, email, telegram_id, обращение, собственник/житель, позиция по ОСС, формат голосования) — с подстановкой существующих в БД значений там, где они есть. Цель — удобное массовое заполнение и обновление контактов по подъезду с возможностью последующей загрузки файла через загрузку контактов (ADM-06). Каждое формирование шаблона обязательно регистрируется в аудит-логе.

### 3. Функциональные требования

* **SR-ADM08-001:** Система должна предоставлять возможность выбора подъезда (entrance) и запроса формирования шаблона для заполнения контактов по всем помещениям этого подъезда.
* **SR-ADM08-002:** Шаблон должен представлять собой таблицу в файле XLSX. Одна строка — один контакт: для каждого помещения выбранного подъезда выводятся все его контакты; если у помещения несколько контактов — добавляются отдельные строки для каждого контакта. Колонки: кадастровый номер (cadastral_number), тип помещения (premises_type), номер помещения (premises_number), а также колонки контактов (phone, email, telegram_id, how_to_address, is_owner, barrier_vote, vote_format). Дополнительно — колонка «Ссылка ТГ» со ссылкой для открытия чата в Telegram (см. SR-ADM08-006). В ячейки подставляются существующие в БД данные; при отсутствии контакта у помещения выводится одна строка с заполненными данными помещения и пустыми полями контактов для заполнения. Колонки **позиция по шлагбаумам** (barrier_vote) и **формат голосования** (vote_format) в выгружаемом шаблоне выводятся русскими подписями (ЗА, Против, Не определился; Электронно, Бумага), как в списке контактов (CORE-03); при последующей загрузке файла (ADM-06) система принимает и русские, и английские значения по правилам маппинга колонок.
* **SR-ADM08-003:** Система должна формировать шаблон в формате, совместимом с последующей загрузкой через ADM-06 (те же названия/алиасы колонок для данных, участвующих в импорте; колонка «ТГ» — только для удобства просмотра, при загрузке не используется).
* **SR-ADM08-004:** Каждое успешное формирование и выдача шаблона должно регистрироваться в аудит-логе (BE-03): идентификатор администратора (user_id), метка времени, подъезд (entrance), формат файла (XLSX), количество строк. В лог не должны попадать сами ПДн в открытом виде; допускаются метаданные: entity_type = "contacts_template", параметры запроса (entrance, row_count).
* **SR-ADM08-005:** Строки в шаблоне должны быть упорядочены по помещению: сначала по типу помещения (premises_type), затем по номеру помещения (premises_number) — естественная сортировка, как в списке контактов для модерации (CORE-03); при нескольких контактах у одного помещения — порядок строк по контактам может быть по id контакта или произвольный, но блок строк по одному помещению должен идти в указанном порядке помещений.
* **SR-ADM08-006:** В шаблон должна входить колонка «Ссылка ТГ» со ссылкой для открытия чата в Telegram. Логика формирования ссылки та же, что и в колонке «ТГ» списка контактов (CORE-03): при наличии telegram_id — ссылка `tg://user?id=<telegram_id>` или `https://t.me/<username>`; при отсутствии telegram_id, но наличии телефона — ссылка `https://t.me/+<цифры_телефона>`. В XLSX ячейка реализуется **формулой**, ссылающейся на столбцы «телефон» (D) и «telegram_id» (F), чтобы при редактировании администратором этих данных ссылка пересчитывалась. При отсутствии данных — пустая ячейка. По возможности применяется Data Validation (выпадающий список) для колонок «позиция по шлагбаумам» и «формат голосования» (допустимые значения: ЗА, Против, Не определился; Электронно, Бумага, Не определился).

### 4. Сценарий использования

**Триггер:** Администратор запрашивает шаблон контактов по выбранному подъезду.

**Main Success Scenario:**
1. Администратор выбирает подъезд и нажимает «Сформировать шаблон».
2. Система выбирает из БД все помещения с данным entrance, упорядочивает их по типу и номеру помещения (SR-ADM08-005), для каждого помещения выводит строки по всем контактам (или одну пустую строку при отсутствии контактов), подставляет известные контактные данные и колонку «ТГ» со ссылкой в Telegram (SR-ADM08-006), формирует файл XLSX и отдаёт его на скачивание; записывает в audit_log событие формирования шаблона (кто, когда, подъезд, число строк).
3. Администратор заполняет пустые ячейки или правит данные и загружает файл через загрузку контактов (ADM-06).

**Alternative Flows:**
* **AF-1 (В подъезде нет помещений):** Система возвращает пустой файл или сообщение об отсутствии помещений; запись в аудит-лог не создаётся.
* **AF-2 (Ошибка доступа к БД):** Система возвращает ошибку, шаблон не выдаётся; запись в аудит-лог не создаётся.

### 5. Модель данных

Используются таблицы **premises** (фильтр по entrance), **contacts** (связь по premise_id = cadastral_number; по одному помещению может быть несколько контактов — в шаблоне по строке на контакт), **oss_voting** (при наличии — по contact_id). Структура шаблона соответствует колонкам, ожидаемым при загрузке контактов (ADM-06), чтобы заполненный файл можно было загрузить без изменений.

### 6. Интеграции и API

* **Method:** `GET /api/admin/import/contacts-template?entrance=...` (или аналог).
* **Request:** Параметр entrance (обязательный). Заголовок `Authorization: Bearer <JWT>`. Доступ — любой роль administrator или super_administrator.
* **Response:** Файл XLSX (Content-Disposition: attachment) с таблицей по SR-ADM08-002. Имя файла — только ASCII: подъезд транслитерируется (кириллица → латиница по ГОСТ 7.79-2000, например подъезд «Б» → `contacts_entrance_B.xlsx`), остальные недопустимые символы заменяются на подчёркивание. Перед отдачей ответа — запись в audit_log по SR-ADM08-004.

### 7. Нефункциональные требования

* **Security:** Доступ только для авторизованного администратора; обязательная регистрация в аудит-логе каждого формирования шаблона (BE-03). В лог не записываются ПДн.
* **Performance:** При большом числе помещений в подъезде — допустимое время формирования и лимит размера ответа по политике системы.

### 8. Доработки UI (план, по аналогии с CORE-03)

Привести экран «Шаблон контактов по подъезду» к тем же паттернам, что и экран ручного аудита контактов (CORE-03), для единообразия и сокращения лишних действий.

* **Выбор подъезда кнопками (аналогично SR-CORE03-004):** вместо выпадающего списка (select) отображать кнопки «Подъезд 1», «Подъезд 2», … по данным `/api/premises/entrances`. После выбора подъезда показывать полоску «Подъезд: N» и кнопку «Выбрать другой подъезд», затем кнопку «Сформировать шаблон». Реализация: [frontend/src/pages/Upload.jsx](../../frontend/src/pages/Upload.jsx) — секция ADM-08; стили по аналогии с `.entrance-buttons`, `.entrance-bar` из [frontend/src/index.css](../../frontend/src/index.css) (CORE-03).
* **Восстановление подъезда из state (опционально):** при переходе на страницу загрузки с экрана «Контакты» (список контактов) передавать в state выбранный подъезд (`entrance`); на странице Upload при наличии `location.state?.entrance` подставлять его в выбранный подъезд для блока шаблона, чтобы не выбирать заново.
* **Формат телефона в XLSX (опционально):** при формировании шаблона подставлять в ячейку телефона значение в читаемом виде +7 (XXX) XXX-XX-XX (если backend при экспорте уже отдаёт расшифрованное значение — применить ту же нормализацию, что и в [phoneFormat.js](../../frontend/src/utils/phoneFormat.js), на backend при сборке строки для XLSX). Цель — единообразие с форматом в форме контакта и на форме подачи заявки.

Итог: один экран выбора подъезда (кнопки), один клик по подъезду и один по «Сформировать шаблон»; при необходимости — предзаполнение подъезда из навигации и читаемый формат телефона в файле.

---

## Реализация (Implementation)

| Компонент | Расположение |
|-----------|---------------|
| Логика импорта только контактов (без создания помещений) | backend/app/import_register.py (новая функция и ожидаемые колонки для контактов) |
| API POST /api/admin/import/contacts | backend/app/routers/import_register.py |
| Блок «Загрузка контактов» и условное отображение блоков по роли | frontend/src/pages/Upload.jsx |
| Формирование шаблона XLSX по подъезду и запись в аудит (ADM-08) | backend: [import_register.py](../../backend/app/import_register.py), [routers/import_register.py](../../backend/app/routers/import_register.py); frontend: [Upload.jsx](../../frontend/src/pages/Upload.jsx) — секция «Шаблон контактов по подъезду». Сортировка помещений (SR-ADM08-005), колонка «ТГ» в XLSX (SR-ADM08-006). Доработки UI: см. п. 8 (выбор подъезда кнопками, state, формат телефона в XLSX). |
