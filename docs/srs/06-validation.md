## VAL-01 — Валидация: смена статуса контакта на помещении

### 1. Архитектурный анализ (CoT)
Реализуется в Logic Module: изменение статуса записи контакта (например, на «валидирован» или «неактуальный»). Доступ только для авторизованного администратора. Влияет на отображение легенды на карте и расчёт кворума (фичи FE-02, CORE-04, CORE-06 — запланированы в бэклоге).

### 2. Описание и цель
Функционал смены статуса контакта по помещению (валидирован / неактуальный и т.д.) для модерации данных и отражения на карте и отчётах. Актуализация базы контактов (подтверждение, смена на «неактуальный») является полностью ручным процессом администратора; автоматическая деактивация при повторном импорте не выполняется (CORE-01, SR-CORE01-024).

### 3. Функциональные требования
* **SR-VAL01-001:** Система должна предоставлять API для установки статуса контакта на «валидирован» (доступ только для администратора/суперадмина).
* **SR-VAL01-002:** Система должна предоставлять API для установки статуса контакта на «неактуальный» (доступ только для администратора/суперадмина).
* **SR-VAL01-003:** Система должна однозначно идентифицировать запись контакта по её идентификатору (и при необходимости по помещению).
* **SR-VAL01-004:** После смены статуса система должна сохранять изменение в БД в рамках транзакции.
* **SR-VAL01-005:** Система должна записывать в аудит-лог факт смены статуса, идентификатор записи, старый и новый статус, идентификатор администратора и время (аудит-лог BE-03 планируется в бэклоге).
* **SR-VAL01-006:** Контакты, загруженные или обновлённые из файла импорта (CORE-01), получают статус PENDING и переходят в статус «Валидирован» или «Неактуальный» только после ручного действия администратора (VAL-01).
* **SR-VAL01-007:** Система должна предоставлять API для получения списка контактов с фильтрацией по помещению и/или статусу (доступ только для администратора). ПДн (телефон, email, telegram_id) расшифровываются на сервере и передаются в ответе.
* **SR-VAL01-008:** Система должна предоставлять UI (страница модерации) для просмотра списка контактов с кнопками смены статуса «Валидировать» / «Сбросить» (возврат в pending) / «Неактуальный» и кнопкой «Редактировать» (переход к форме ADM-03, SR-ADM03-007) без перезагрузки страницы.
* **SR-VAL01-009:** Система должна предоставлять API для возврата статуса контакта в «pending» (доступ только для администратора/суперадмина). Допустимые значения статуса при смене: `pending`, `validated`, `inactive`.

### 4. Сценарий использования
**Триггер:** Администратор подтверждает контакт или помечает запись как неактуальную.
**Main Success Scenario:**
1. Администратор выбирает запись и действие (валидировать / неактуально).
2. Клиент отправляет запрос с JWT.
3. Сервер проверяет права, обновляет статус, пишет аудит, возвращает успех.
**Alternative Flows:**
* **AF-1 (Запись не найдена):** Сервер возвращает 404.
* **AF-2 (Нет прав):** Сервер возвращает 403.

### 5. Модель данных
**Update:** Контакт/анкета — атрибут статус (например: pending / validated / inactive). Аудит-таблица: entity_type, entity_id, action, old_value, new_value, user_id, ip, timestamp.

### 6. Интеграции и API
* **Method:** `PATCH /api/admin/contacts/{contact_id}/status`
* **Request:**
```json
{
  "status": "validated"
}
```
* **Response (успех):**
```json
{
  "contact_id": "uuid",
  "status": "validated"
}
```

### 7. Нефункциональные требования
* **Security:** Только роль administrator или super_administrator. Аудит обязателен (BE-03 будет реализован в бэклоге).
* **Рекомендация (UX):** При просмотре контакта в интерфейсе должна отображаться дата последнего импорта реестра по данному помещению, чтобы модератор мог оценить риск неактуальности данных.

---

## CORE-02 — Валидация и лимиты: типы, лимиты (10/10), дедупликация

### 1. Архитектурный анализ (CoT)
Реализуется в Logic Module при приёме анкеты (POST /api/submit): проверка типов полей (телефон, email, telegram), проверка лимита невалидированных записей на помещение (10) и общего лимита с IP (BE-04 планируется в бэклоге), дедупликация (один контакт на помещение или политика «последний перезаписывает» — по БТ уточнить). Связан с потоком загрузки реестров ( CORE-01, LOST-02 ): валидация форматов и правил применяется и к данным импорта; приоритет фичи повышен в связи с критичностью контура импорта для навигации и аналитики.

### 2. Описание и цель
Валидация форматов контактов, контроль лимита невалидированных записей на помещение (до 10) и дедупликация для предотвращения спама и дублей.

### 3. Функциональные требования
* **SR-CORE02-001:** Система должна проверять формат поля «телефон» (допустимые символы, длина, маска) перед сохранением.
* **SR-CORE02-002:** Система должна проверять формат поля «email» (синтаксис email) перед сохранением.
* **SR-CORE02-003:** Система должна проверять формат поля «telegram_id» (если передаётся) перед сохранением.
* **SR-CORE02-004:** Система должна отклонять анкету, если для выбранного помещения уже существует 10 невалидированных записей (лимит «10 невалидированных» на помещение).
* **SR-CORE02-005:** Система должна применять правило дедупликации по помещению и контактным полям (телефон, email, telegram_id): при наличии существующей записи для данного помещения поведение определяется степенью совпадения данных — обновление только даты и лог (SR-CORE02-007), дополнение пустых полей (SR-CORE02-008) или отказ при конфликте (SR-CORE02-009); во всех случаях обновления ведётся аудит. Дедупликация и проверка конфликтов выполняются **только** путём сравнения Blind Index соответствующих полей (колонки `phone_idx`, `email_idx`, `telegram_id_idx`) в БД. Прямое сравнение зашифрованных значений (ciphertext) или поиск по подстроке не допускаются. Перед вычислением Blind Index значения нормализуются по правилам BE-02 (SR-BE02-008): email — нижний регистр, без пробелов; телефон — 11 цифр с ведущей «7»; telegram_id — строковый формат.
* **SR-CORE02-006:** При нарушении лимита или валидации система должна возвращать понятный код ошибки и сообщение без раскрытия внутренней структуры.
* **SR-CORE02-007 (полное совпадение):** Если для помещения уже есть контакт с теми же телефоном, email и telegram_id — система обновляет только дату последнего изменения записи и добавляет запись в аудит-лог (без изменения остальных полей).
* **SR-CORE02-008 (дополнение):** Если для помещения есть контакт, у которого часть полей (телефон, email, telegram_id) совпадает с входящими данными, а остальные поля в существующей записи пустые — система дополняет эти пустые поля значениями из формы ввода, обновляет дату последнего изменения и пишет в аудит-лог.
* **SR-CORE02-009 (конфликт):** Если для помещения есть контакт, у которого часть полей совпадает с входящими данными, а часть полей не совпадает и при этом не пуста в существующей записи — система отклоняет анкету с сообщением, предлагающим связаться с администраторами для разрешения конфликта.

### 4. Сценарий использования
**Триггер:** Отправка анкеты (POST /api/submit).
**Main Success Scenario:**
1. Сервер проверяет форматы полей, лимит невалидированных по помещению, дедупликацию.
2. При успехе сохраняет новую запись или обновляет существующую (см. AF-3, AF-4).
**Alternative Flows:**
* **AF-1 (Ошибка валидации формата):** Возврат 400 с указанием поля и типа ошибки.
* **AF-2 (Лимит 10 невалидированных на помещение):** Возврат 400/409 с сообщением «Достигнут лимит невалидированных записей по этому помещению».
* **AF-3 (Полное совпадение):** Найден контакт по помещению с теми же телефоном, email и telegram_id. Обновляются только дата последнего изменения и запись в аудит-логе; возврат успеха.
* **AF-4 (Дополнение):** Найден контакт по помещению с частичным совпадением полей; остальные поля в записи пустые. Система дополняет пустые поля из формы, обновляет дату последнего изменения, пишет в аудит; возврат успеха.
* **AF-5 (Конфликт):** Найден контакт по помещению, часть полей совпадает, часть не совпадает и не пуста. Возврат 409 с сообщением о необходимости связаться с администраторами.

### 5. Модель данных
Используются существующие сущности помещений и контактов. Для дедупликации сопоставление выполняется по помещению и Blind Index в колонках `phone_idx`, `email_idx`, `telegram_id_idx` (BE-02); сравнение зашифрованных полей (ciphertext) или по подстроке не допускается. Перед вычислением хеша применяется нормализация по BE-02 (SR-BE02-008). Для логики обновления (SR-CORE02-007, SR-CORE02-008) в сущности контакта должно быть поле «дата последнего изменения»; сопоставление определяет один из исходов: полное совпадение → только обновить дату и лог; частичное совпадение при пустых остальных полях → дополнение; частичное совпадение при непустых отличных значениях → конфликт, отказ.

### 6. Интеграции и API
Ответы ошибок в рамках POST /api/submit:
```json
{
  "detail": "Validation failed",
  "errors": [
    { "field": "phone", "message": "Invalid format" }
  ]
}
```
```json
{
  "detail": "Premise limit exceeded: max 10 unvalidated contacts per premise"
}
```
При конфликте данных (SR-CORE02-009):
```json
{
  "detail": "Contact data conflict: existing record has different values. Please contact administrators to resolve.",
  "code": "CONTACT_CONFLICT"
}
```

### 7. Нефункциональные требования
* **Performance:** Валидация форматов — быстрая; проверка лимита — один запрос COUNT по помещению с индексом.

---

### 8. Реализация (Implementation)

| Компонент | Расположение |
|-----------|--------------|
| Валидация форматов (CORE-02) | [backend/app/validators.py](../../backend/app/validators.py) |
| Лимит и дедупликация при submit (CORE-02) | [backend/app/submit_service.py](../../backend/app/submit_service.py) |
| Список контактов (VAL-01) | [backend/app/routers/admin_contacts.py](../../backend/app/routers/admin_contacts.py) — GET /api/admin/contacts |
| Смена статуса контакта (VAL-01) | [backend/app/routers/admin_contacts.py](../../backend/app/routers/admin_contacts.py) — PATCH /api/admin/contacts/{contact_id}/status |
| UI модерации контактов (VAL-01) | [frontend/src/pages/AdminContactsList.jsx](../../frontend/src/pages/AdminContactsList.jsx) |
| Таблица аудит-лога (VAL-01-005, BE-03) | [backend/alembic/versions/002_audit_log.py](../../backend/alembic/versions/002_audit_log.py) |
| Документация развёртывания | [docs/deploy/06-validation.md](../deploy/06-validation.md) |

