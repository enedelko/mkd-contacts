# UI-01, FE-06 — Выбор подъезда (компонент) и шахматка помещений на главной

Документ содержит две связанные фичи:
- **UI-01** — переиспользуемый React-компонент выбора подъезда (EntrancePicker). Извлекается из дублирующегося кода в AdminContactsList, Upload, Premises/AdminContacts; используется на главной (FE-06) и при рефакторинге существующих страниц.
- **FE-06** — шахматка помещений на главной странице (зависит от UI-01).

---

## UI-01 — EntrancePicker: переиспользуемый компонент выбора подъезда

### 1. Архитектурный анализ (CoT)

Реализуется на Frontend (React). Сейчас логика выбора подъезда (загрузка `GET /api/premises/entrances`, отображение кнопок, состояние «выбранный подъезд», бар с текущим подъездом и ссылкой «Выбрать другой подъезд») **продублирована** в трёх местах: `AdminContactsList.jsx` (кнопки + бар), `Upload.jsx` (кнопки + бар в блоке шаблона), `AdminContacts.jsx` / `Premises.jsx` (выпадающий список в каскаде). Стили `.entrance-buttons`, `.entrance-btn`, `.entrance-bar`, `.entrance-current`, `.btn-link` также продублированы в `index.css` под разными родительскими селекторами (`.upload-page`, `.admin-contacts-list-page`). Цель — извлечь общую логику и разметку в один компонент `EntrancePicker`, который можно переиспользовать на главной (FE-06) и при рефакторинге существующих страниц.

### 2. Описание и цель

Компонент `EntrancePicker` инкапсулирует: загрузку списка подъездов (API), отображение кнопок выбора (режим «не выбран»), отображение бара текущего подъезда с возможностью сброса (режим «выбран»), состояния загрузки и пустых данных. Принимает callback `onSelect(entrance)` и опциональные пропсы (prompt-текст, дополнительные элементы в баре). Цель — устранить дублирование, унифицировать UX выбора подъезда на всех страницах и упростить добавление выбора подъезда на главную (FE-06).

### 3. Функциональные требования

* **SR-UI01-001:** Система должна содержать переиспользуемый React-компонент `EntrancePicker`, инкапсулирующий загрузку подъездов (`GET /api/premises/entrances`), их отображение и управление состоянием выбора.
* **SR-UI01-002:** Компонент должен отображать **кнопки подъездов** (режим «не выбран»): каждая кнопка — `entranceButtonLabel(ent)`, стиль `.entrance-btn`. При клике — вызов `onSelect(entrance)`.
* **SR-UI01-003:** Компонент должен отображать **бар текущего подъезда** (режим «выбран»): текст `entranceBarLabel(entrance)`, кнопка «Выбрать другой подъезд» (сброс выбора). Опционально — слот для дополнительных элементов (ссылка «Сформировать шаблон» и т.п.).
* **SR-UI01-004:** При загрузке данных компонент должен отображать индикатор загрузки; при отсутствии подъездов — настраиваемое сообщение (по умолчанию «Данные по дому пока не загружены»).
* **SR-UI01-005:** Компонент должен принимать пропсы: `onSelect(entrance)` (обязательный callback), `selected` (текущий подъезд или null), `onReset` (callback сброса), `prompt` (текст подсказки, опционально), `emptyMessage` (текст при отсутствии данных, опционально), `barExtra` (доп. элементы в баре, опционально).
* **SR-UI01-006:** Компонент должен поддерживать инициализацию выбранного подъезда из внешнего состояния (например `location.state.entrance`), чтобы при переходе между страницами подъезд восстанавливался.
* **SR-UI01-007:** Стили выбора подъезда (`.entrance-buttons`, `.entrance-btn`, `.entrance-bar`, `.entrance-current`, `.btn-link`) должны быть вынесены из контекстных селекторов (`.upload-page`, `.admin-contacts-list-page`) в общие классы без привязки к родительской странице.
* **SR-UI01-008:** При рефакторинге существующих страниц (`AdminContactsList`, `Upload`, при желании `AdminContacts`/`Premises`) логика выбора подъезда должна быть заменена на `EntrancePicker`. Поведение страниц не должно измениться.

### 4. Сценарий использования

**Триггер:** Компонент монтируется на странице, где необходим выбор подъезда.

**Main Success Scenario:**
1. Компонент загружает `GET /api/premises/entrances` и отображает кнопки подъездов.
2. Пользователь кликает по кнопке → `onSelect(entrance)` вызывается; компонент переключается в режим «бар».
3. Пользователь нажимает «Выбрать другой подъезд» → `onReset()` вызывается; компонент возвращается в режим «кнопки».

**Alternative Flows:**
* **AF-1 (Нет подъездов):** Компонент отображает `emptyMessage`.
* **AF-2 (Ошибка загрузки):** Компонент отображает сообщение об ошибке.
* **AF-3 (Инициализация из state):** Если передан `selected` — компонент сразу отображает бар.

### 5. Модель данных

Не меняется. Используется существующий `GET /api/premises/entrances` (FE-03). Утилиты `entranceButtonLabel`, `entranceBarLabel` — из `utils/entranceLabel.js`.

### 6. Интеграции и API

Без изменений на Backend. Компонент использует `GET /api/premises/entrances` (уже существует, без auth).

### 7. Нефункциональные требования

* **Reusability:** Компонент не содержит бизнес-логики конкретной страницы; поведение определяется пропсами и callbacks.
* **Backward compatibility:** Рефакторинг существующих страниц не должен менять их поведение (визуально и функционально).
* **Accessibility:** Группа кнопок — `role="group"` с `aria-label`; бар — семантическая разметка.

---

## FE-06 — Главная: шахматка помещений

Зависимости: **UI-01** (EntrancePicker), FE-03 (подъезды/этажи/помещения), FE-02 (цвет по ОСС), FE-04 (форма), ADM-03 (админ-контакты), CORE-04 (кворум).

### 1. Архитектурный анализ (CoT)

Реализуется на Frontend (React) и Backend (FastAPI). На главной странице (`/`) блок кворума ОСС (CORE-04) размещается вверху; под ним — компонент `EntrancePicker` (UI-01). После выбора подъезда Frontend запрашивает новый эндпоинт `GET /api/premises/chessboard?entrance=...`, который возвращает помещения подъезда, сгруппированные по этажам, с агрегированными флагами наличия контактов и состоянием по ОСС — без раскрытия ПДн. Над шахматкой отображается % площади помещений, готовых голосовать «ЗА» (та же формула, что и кворум). Клик по ячейке ведёт на форму контакта (FE-04) для неавторизованных пользователей или на `/admin/contacts` (ADM-03) для админов/суперадминов.

### 2. Описание и цель

На главной странице пользователь видит блок кворума ОСС (как сейчас) и показатель % жителей в Электронном доме по дому; затем выбирает подъезд через `EntrancePicker` (UI-01). После выбора подъезда отображается шахматка — таблица этажей от верхнего к нижнему, в каждой строке-этаже — ячейки-помещения. Над шахматкой — показатели % площади с голосами «ЗА» и % в Электронном доме по подъезду. В ячейке: тип помещения (мелко), номер помещения (крупно), иконка Telegram при наличии TG id или телефона, иконка письма при наличии только email; цвет фона — по позиции ОСС (легенда FE-02). При клике на ячейку открывается форма добавления контакта (обычный пользователь) или страница `/admin/contacts` (админ/суперадмин). Цель — быстрый обзор помещений подъезда, визуальная оценка охвата и переход к форме/админке по клику.

### 3. Функциональные требования

* **SR-FE06-001:** Система должна отображать на главной странице блок кворума ОСС (CORE-04) **вверху**, над выбором подъезда и над шахматкой.
* **SR-FE06-002:** Под блоком кворума система должна отображать компонент `EntrancePicker` (UI-01) для выбора подъезда.
* **SR-FE06-003:** После выбора подъезда система должна отображать шахматку помещений этого подъезда. «Выбрать другой подъезд» — через `EntrancePicker`.
* **SR-FE06-004:** Над шахматкой (после выбора подъезда) система должна отображать долю (%) площади помещений, готовых голосовать в ОСС, по той же формуле, что и кворум: площадь с голосами «ЗА» / общая площадь (для выбранного подъезда). Данные берутся из ответа `chessboard`.
* **SR-FE06-005:** Шахматка представляет собой таблицу: строки — этажи, от **максимального к минимальному** в выбранном подъезде (сортировка: числовой порядок этажа, как в FE-03).
* **SR-FE06-006:** В каждой строке (этаже) — ячейки, по одной на помещение этажа. Помещения в строке упорядочены по типу и номеру (`premises_type`, затем естественная сортировка `premises_number` — как в списке контактов CORE-03).
* **SR-FE06-007:** Если на этаже **больше 9 помещений** — ячейки разбиваются на несколько визуальных строк по 9 ячеек (или конфигурируемый порог, по умолчанию 9). Один логический «этаж» может занимать несколько строк таблицы.
* **SR-FE06-008:** В каждой ячейке отображать: **тип помещения** мелким шрифтом (например «Кв», «Паркинг», «Кл»), **номер помещения** крупным шрифтом.
* **SR-FE06-009:** Иконка **Telegram** (лого ТГ) — показывать в ячейке, если у помещения есть хотя бы один контакт с заполненным `telegram_id` или `phone` (логика как в списке контактов: возможность связаться через ТГ по id или по номеру телефона).
* **SR-FE06-010:** Иконка **письма** (✉ или аналогичная) — показывать в ячейке, если у помещения есть контакт только с email (нет ни `telegram_id`, ни `phone`).
* **SR-FE06-011:** **Цвет фона ячейки** определяется позицией по ОСС: **full** (все активные собственники планируют голосовать «ЗА») — ярко-зелёный; **vote_for** (хотя бы один собственник планирует голосовать «ЗА», но не все) — светло-зелёный; **registered** (хотя бы один собственник зарегистрирован в Электронном доме, но нет голосов «ЗА») — светло-жёлтый; **none** (нет информации) — белый фон. Для full и vote_for учитываются только контакты-собственники (без проживающих). Выбранная/активная ячейка — ярко-синяя рамка (опционально).
* **SR-FE06-012:** При клике на ячейку, если пользователь **не авторизован** (нет JWT) — переход на `/form` (форма FE-04) с передачей выбранного помещения в `location.state` (premise: `{ premise_id, number }`, entrance, floor, type, hasEntrances).
* **SR-FE06-013:** При клике на ячейку, если пользователь **авторизован** (админ или суперадмин) — переход на `/admin/contacts` (ADM-03) с передачей в `location.state` выбранного помещения (premise_id, entrance, floor, type, number) для подстановки в каскадные фильтры.
* **SR-FE06-014:** Система должна предоставлять публичный (без авторизации) эндпоинт `GET /api/premises/chessboard?entrance=...`, возвращающий данные для шахматки выбранного подъезда.
* **SR-FE06-015:** Ответ эндпоинта должен содержать этажи в порядке убывания (от макс. к мин.), для каждого этажа — список помещений с полями: `premise_id` (cadastral_number), `premises_type`, `premises_number`, `floor`, а также агрегаты по контактам: `contact_state` (none | registered | vote_for | full), `has_telegram_or_phone` (bool), `has_email_only` (bool). ПДн не раскрываются — только флаги наличия.
* **SR-FE06-016:** На главной странице в блоке кворума (CORE-04) система должна отображать показатель «% жителей в Электронном доме» по дому в целом: доля площади помещений, где хотя бы один контакт зарегистрирован в ЭД (та же формула, что и кворум — площадь таких помещений / общая площадь). Данные берутся из ответа `GET /api/buildings/{building_id}/quorum` (поля `area_registered_ed`, `ed_ratio` по SR-CORE04-007).
* **SR-FE06-017:** Над шахматкой (после выбора подъезда) система должна отображать показатель «% в Электронном доме» по выбранному подъезду: доля площади помещений подъезда, где хотя бы один контакт зарегистрирован в ЭД. Данные берутся из ответа `chessboard` (поля `entrance_area_registered_ed`, `entrance_ed_ratio`).

### 4. Сценарий использования

**Триггер:** Пользователь (или админ) открывает главную страницу (`/`).

**Main Success Scenario:**
1. Система отображает блок кворума ОСС вверху страницы и `EntrancePicker` с кнопками подъездов.
2. Пользователь выбирает подъезд.
3. Система запрашивает `GET /api/premises/chessboard?entrance=...` и отображает над шахматкой: % площади «ЗА» и % в Электронном доме по подъезду; затем таблицу этажей (сверху вниз) с ячейками-помещениями (тип, номер, иконки, цвет фона по ОСС).
4. Пользователь кликает по ячейке «Кв 42» → переход на `/form` с помещением в state.
5. (Админ) Пользователь кликает по ячейке → переход на `/admin/contacts` с помещением в state.

**Alternative Flows:**
* **AF-1 (Нет подъездов):** `EntrancePicker` отображает сообщение «Данные по дому пока не загружены».
* **AF-2 (Смена подъезда):** Пользователь нажимает «Выбрать другой подъезд» в `EntrancePicker` — шахматка сбрасывается.
* **AF-3 (Ошибка загрузки):** При ошибке запроса chessboard — сообщение «Не удалось загрузить данные» с возможностью повторить.

### 5. Модель данных

**Затрагиваемые сущности:** premises (подъезд, этаж, тип, номер, площадь, кадастровый номер — по LOST-01), contacts (premise_id, status, phone, email, telegram_id — зашифрованы по BE-02), oss_voting (barrier_vote — связь контакт → голосование). Новых таблиц не требуется; эндпоинт chessboard агрегирует данные из существующих.

Реализация `contact_state` — раскраска по позиции ОСС (full и vote_for — только по собственникам, проживающие не учитываются):
- **full** — все активные собственники по помещению имеют `barrier_vote = 'for'` (ярко-зелёный).
- **vote_for** — хотя бы один собственник имеет `barrier_vote = 'for'`, но не все (светло-зелёный).
- **registered** — нет голосов «ЗА», но хотя бы один собственник зарегистрирован в Электронном доме (`registered_in_ed = 'yes'`) (светло-жёлтый).
- **none** — нет информации (белый).

Учитываются только контакты со статусом `pending` или `validated` (не `inactive`). Дополнительно в SQL сохраняется `cnt_validated` (кол-во валидированных контактов) для возможного использования в будущем.

Флаги `has_telegram_or_phone` / `has_email_only` определяются по факту наличия непустого зашифрованного значения в соответствующих полях (phone, telegram_id, email) среди активных контактов помещения — без расшифровки ПДн (достаточно проверки IS NOT NULL / != '').

### 6. Интеграции и API

* **Method:** `GET /api/premises/chessboard?entrance={entrance}`
* **Auth:** без авторизации (публичный).
* **Параметры:** `entrance` — обязательный, подъезд.
* **Response:**
```json
{
  "entrance": "1",
  "entrance_area_voted_for": 850.0,
  "entrance_total_area": 3200.5,
  "entrance_ratio": 0.265,
  "entrance_area_registered_ed": 420.0,
  "entrance_ed_ratio": 0.131,
  "floors": [
    {
      "floor": "25",
      "premises": [
        {
          "premise_id": "77:01:0001001:1234",
          "premises_type": "Квартира",
          "premises_number": "96",
          "contact_state": "full",
          "has_telegram_or_phone": true,
          "has_email_only": false
        },
        {
          "premise_id": "77:01:0001001:1235",
          "premises_type": "Квартира",
          "premises_number": "97",
          "contact_state": "none",
          "has_telegram_or_phone": false,
          "has_email_only": false
        }
      ]
    },
    {
      "floor": "24",
      "premises": [ ]
    }
  ]
}
```

Поля `entrance_area_voted_for`, `entrance_total_area`, `entrance_ratio` — расчёт по той же формуле, что и кворум (CORE-04), но в рамках выбранного подъезда. Используются для отображения % площади «ЗА» над шахматкой (SR-FE06-004). Поля `entrance_area_registered_ed`, `entrance_ed_ratio` — сумма площадей помещений подъезда, где хотя бы один контакт (pending/validated) зарегистрирован в Электронном доме (`registered_in_ed = 'yes'`), и доля от общей площади подъезда; используются для отображения % в ЭД над шахматкой (SR-FE06-017).

### 7. Нефункциональные требования

* **Performance:** Один запрос на подъезд; агрегация помещений и контактов — SQL с индексами по entrance/floor. При большом числе помещений в подъезде (>200) — приемлемое время ответа (<500 мс).
* **Security:** ПДн не раскрываются; эндпоинт публичный, возвращает только флаги и состояния. Зашифрованные поля не расшифровываются.
* **Accessibility:** Таблица-шахматка должна иметь aria-label; ячейки — роль кнопки (role="button") или `<button>` с описанием помещения для скринридеров.
