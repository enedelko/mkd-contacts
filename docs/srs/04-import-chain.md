# Цепочка импорта реестра

**Порядок: LOST-01 → BE-02 → CORE-01 → LOST-02**

---

## CORE-01 — Импорт реестра (CSV/XLS). Учёт собственников и помещений

### 1. Архитектурный анализ (CoT)
Импорт выполняется в Backend (FastAPI), данные сохраняются в PostgreSQL. Модуль логики расширяется операциями массовой вставки/обновления помещений и контактов собственников. Реализация невозможна без **LOST-01** (схема БД: помещения, контакты) и **BE-02** (шифрование ПДн). Блокер для навигации и фильтров — без реестра помещений и контактов карта и расчёт кворума не имеют данных.

### 2. Описание и цель
Инструмент загрузки реестра помещений и контактов собственников из файлов CSV/XLS. Загрузка идёт в денормализованном виде: одна строка файла = одно помещение + один контакт; на одно помещение может приходиться несколько строк (несколько контактов). Цель — наполнение БД помещениями МКД и контактами собственников для навигации и расчёта кворума.

**Ограничение реестра:** Импортируемый реестр не содержит ФИО собственников. Единственным идентификатором владения является связка Room ID + Кадастровый номер + Доля.

### 3. Функциональные требования
* **SR-CORE01-001:** Система должна принимать файл загрузки через API (доступ только для авторизованного администратора).
* **SR-CORE01-002:** Система должна поддерживать формат CSV с кодировкой UTF-8.
* **SR-CORE01-003:** Система должна поддерживать формат XLS (или XLSX) для чтения листов с данными.
* **SR-CORE01-004:** Система должна извлекать из файла поля помещений: кадастровый номер (или идентификатор помещения), площадь, подъезд, этаж, тип помещения, номер помещения; и при наличии — поля контактов (см. перечень ПДн ниже). Кадастровый номер является обязательным для загрузки: строки без кадастрового номера не принимаются.
* **SR-CORE01-005:** Система должна валидировать обязательные поля (включая кадастровый номер) перед записью в БД.
* **SR-CORE01-006:** Система должна записывать данные в рамках транзакции: помещения — уникально по кадастровому номеру/ид; контакты — по одной записи на строку файла (связь с помещением), т.е. допускается несколько контактов на одно помещение (денормализованная загрузка).
* **SR-CORE01-007:** Система должна возвращать отчёт: количество принятых строк и список ошибок по строкам (при наличии).
* **SR-CORE01-008:** При критической ошибке формата файла система должна откатывать транзакцию и не вносить изменений.
* **SR-CORE01-009:** Номер помещения должен иметь строковый тип (String), чтобы поддерживать значения типа «9А», «IX», «10-б».
* **SR-CORE01-010:** Все ПДн, передаваемые при импорте (см. перечень ниже), должны шифроваться бэкендом (BE-02) перед записью в БД. Прямая запись открытых ПДн в БД запрещена.
* **SR-CORE01-011:** Сопоставление контактов при импорте должно выполняться по полям phone, email и telegram_id с использованием их Blind Index (поиск по зашифрованным данным без расшифровки).
* **SR-CORE01-012:** Четвёртое информационное поле контакта — «Обращение» (как обращаться к собственнику); используется для персонализации, так как ФИО в реестре отсутствует.
* **SR-CORE01-013 (новые контакты):** При совпадении Room ID (помещения) контакт, не найденный по Blind Index среди существующих записей по этому помещению, сохраняется как новый со статусом «Не валидирован» (PENDING). Любые новые контактные данные (телефон, email, telegram_id), поступающие из файла импорта, автоматически получают статус PENDING и требуют ручной проверки модератором (VAL-01).
* **SR-CORE01-014 (обогащение):** Если у существующего в БД контакта поле (email, phone, telegram_id или «Обращение») пустое, а в файле импорта оно заполнено — система должна обновить соответствующее поле в БД данными из файла.
* **SR-CORE01-015 (защита данных):** Если в файле импорта поле пустое, а в БД оно уже заполнено — данные в БД сохраняются без изменений.
* **SR-CORE01-016 (коллизия):** Если хотя бы один из идентификаторов (phone, email, telegram_id) совпадает с существующим контактом по помещению, но другой идентификатор в той же строке файла прямо противоречит данным в БД (например, тот же телефон, но другой email) — такая запись не импортируется.
* **SR-CORE01-017:** По завершении импорта система должна выполнить загрузку всех валидных строк и вернуть отчёт, содержащий список номеров строк, в которых возникли коллизии (или иные причины пропуска), с кратким указанием причины пропуска для каждой.

**Жёсткая нормализация номера помещения (room_id) при импорте:**

* **SR-CORE01-018 (извлечение):** При импорте из Excel/CSV система должна извлекать номер помещения с помощью регулярных выражений, захватывая **первое** подходящее вхождение в строке. Любые пояснения, идущие после номера, игнорируются (например, из «кв. 12 (жилое)» извлекается «12»).
* **SR-CORE01-019 (паттерны):** Поддерживаемые паттерны номера помещения: арабские цифры (123); цифры с литерами слитно или через дефис (5б, 5-Б, А-23); римские цифры (I–XXX). Римские числа с литерами не сочетаются — обработка ведётся по принципу «либо римское число, либо арабское с литерой».
* **SR-CORE01-020 (очистка):** После извлечения строка номера помещения должна быть приведена к нижнему регистру и из неё должны быть удалены все пробелы.
* **SR-CORE01-020a (префиксы):** Должна выполняться очистка от префиксов: «кв», «пом», «оф», «№», «подвал» (и их вариантов с точкой/пробелом).
* **SR-CORE01-021 (мапинг литер):** Кириллические символы в номере помещения должны строго заменяться на латинские по схеме: «а» → «a», «б» → «b», «в» → «b» (сведение «в» к «b» обосновано спецификой конкретного МКД).
* **SR-CORE01-022 (римские числа):** Римские числа в диапазоне I–XXX должны конвертироваться в арабские цифры (например, IX → 9, XXX → 30). Применяется в рамках правила «либо римское число, либо арабское с литерой».
* **SR-CORE01-023:** Итоговый нормализованный `room_id` является единым ключом для сопоставления помещений и контактов в БД (связь строки файла с записью помещения, правила SR-CORE01-013–016).
* **SR-CORE01-024 (сохранение актуальности):** Система не выполняет автоматическую деактивацию существующих валидированных контактов при повторном импорте реестра, так как отсутствие ФИО не позволяет достоверно определить смену собственника; актуализация выполняется вручную администратором (VAL-01).

### 4. Сценарий использования
**Триггер:** Администратор загружает файл реестра (помещения и контакты собственников).
**Main Success Scenario:**
1. Администратор выбирает файл CSV/XLS (денормализованный: строки «помещение + контакт») и отправляет запрос.
2. Система проверяет формат и права, парсит файл, валидирует строки, применяет правила сопоставления и обработки (новые контакты, обогащение, защита данных; коллизии не импортируются), записывает все валидные строки в БД (ПДн — в зашифрованном виде) и по завершении возвращает отчёт с количеством принятых/отклонённых строк и списком ошибок по номерам строк (включая коллизии с указанием причины пропуска).
**Alternative Flows:**
* **AF-1 (Ошибка валидации):** Если часть строк невалидна, система записывает только валидные и возвращает в отчёте перечень ошибок по номерам строк.
* **AF-2 (Таймаут/недоступность БД):** При недоступности БД система возвращает HTTP 503 и не сохраняет данные.

### 5. Модель данных

**Денормализованная загрузка:** Одна строка файла соответствует одной паре «помещение + контакт». На одно помещение может приходиться несколько строк (разные контакты). При импорте система формирует/обновляет записи в таблицах **premises** (уникально по помещению) и **contacts** (одна запись на строку с контактом, связь с помещением по кадастровому номеру/ид).

**Поля помещений** (по LOST-01): кадастровый_номер (или id) — **обязателен для загрузки**; площадь, подъезд, этаж, тип_помещения, номер_помещения, общая_площадь_МКД (при необходимости). Значение номера помещения при импорте нормализуется по правилам SR-CORE01-018–SR-CORE01-022; сохранённый нормализованный `room_id` используется как ключ для сопоставления данных в БД.

**Поля контактов** (по LOST-01): связь с помещением (premise_id), контактные данные и метаданные — см. перечень ПДн ниже. Остальные поля контакта (дата_создания, ip, статус и т.д.) задаёт бэкенд при импорте. Сопоставление контактов при импорте ведётся по полям phone, email и telegram_id (с использованием их Blind Index). Четвёртое информационное поле — «Обращение» (для персонализации; ФИО в реестре отсутствует).

**ПДн, хранимые при импорте (все — только в зашифрованном виде, BE-02):**

| Категория | Поля | Обязательность |
|-----------|------|----------------|
| Контактные данные | телефон, email, telegram_id | Для строки с контактом обязательно **хотя бы одно** из трёх (остальные опциональны) |
| Обращение | как обращаться к собственнику | Опционально (например: «Иван Иванович», «г-н Петров») — ПДн; используется для персонализации |

Итого: телефон, email и telegram_id по колонкам файла — опциональны по отдельности, но для каждой строки, считающейся контактом, должна быть заполнена хотя бы одна из этих колонок. Поле «Обращение» — полностью опционально.

### 6. Интеграции и API
* **Method:** `POST /api/admin/import/register`
* **Request:** multipart/form-data с полем `file` (CSV или XLS). Заголовок `Authorization: Bearer <JWT>`.
* **Response (успех):**
```json
{
  "accepted": 120,
  "rejected": 3,
  "errors": [
    { "row": 5, "message": "Missing required field: area" },
    { "row": 12, "message": "Invalid cadastral number format" },
    { "row": 18, "message": "Collision: phone matches existing contact, email contradicts" }
  ]
}
```
Отчёт возвращается по завершении загрузки всех валидных строк; в `errors` входят в том числе номера строк с коллизиями (SR-CORE01-016) с указанием причины пропуска.
* **Response (ошибка формата/отказ):**
```json
{
  "detail": "Unsupported file format or corrupted file"
}
```

### 7. Нефункциональные требования
* **Security:** Доступ только для роли администратор/суперадмин; логирование факта импорта и объёма данных (аудит).
* **Performance:** Рекомендуемый лимит размера файла (например, до 5 MB) и таймаут обработки; при больших объёмах — асинхронная задача или батчи.

---

## LOST-02 — Страница загрузки реестров (Upload Page)

### 1. Архитектурный анализ (CoT)
Страница реализуется на Frontend (React) в составе админ-интерфейса и взаимодействует с API импорта (CORE-01). Обеспечивает выбор файла с ПК и мобильных устройств, отображение инструкции по формату и валидацию структуры файла до отправки или на ответе сервера с детализацией ошибки. Связана с CORE-01.

### 2. Описание и цель
Интерфейс загрузки реестров: инструкция по форматам и колонкам, выбор файла (.xlsx, .csv), валидация набора колонок с выдачей критической ошибки и сравнением «Обнаруженные» vs «Ожидаемые» колонки. Цель — снижение ошибок импорта и соответствие ожидаемой структуре данных.

### 3. Функциональные требования
* **SR-LOST02-001:** На странице загрузки должна быть размещена инструкция по поддерживаемым форматам файлов (.xlsx, .csv) и список ожидаемых колонок с описанием.
* **SR-LOST02-002:** Система должна предоставлять возможность выбора файла с ПК (выбор через диалог файловой системы).
* **SR-LOST02-003:** Система должна предоставлять возможность выбора файла с мобильных устройств (поддержка input type file с accept и при необходимости capture для камеры/галереи по политике).
* **SR-LOST02-004:** Система должна выполнять валидацию структуры файла: если набор колонок не совпадает с ожидаемым, должна выдаваться критическая ошибка без выполнения импорта.
* **SR-LOST02-005:** Сообщение об ошибке валидации структуры должно содержать явное сравнение: «Обнаруженные колонки» и «Ожидаемые колонки» (списки названий колонок).
* **SR-LOST02-006:** Критическая ошибка структуры должна отображаться пользователю на странице (и при необходимости возвращаться в теле ответа API при проверке на бэкенде).

### 4. Сценарий использования
**Триггер:** Администратор открывает страницу загрузки реестров.
**Main Success Scenario:**
1. Администратор читает инструкцию, выбирает файл .xlsx или .csv с ожидаемым набором колонок и запускает загрузку.
2. Система проверяет структуру (на клиенте и/или сервере), выполняет импорт и отображает отчёт.
**Alternative Flows:**
* **AF-1 (Ошибка структуры):** Набор колонок не совпадает с ожидаемым — система выдаёт критическую ошибку с сравнением «Обнаруженные колонки» vs «Ожидаемые колонки»; импорт не выполняется.
* **AF-2 (Неподдерживаемый формат/повреждённый файл):** Система отображает сообщение об ошибке формата или целостности файла; импорт не выполняется.

### 5. Модель данных
Не меняется; список ожидаемых колонок — по CORE-01 (поля помещений и при наличии: телефон, email, telegram_id, как обращаться к собственнику).

### 6. Интеграции и API
* **Method:** `POST /api/admin/import/register` (как в CORE-01). При валидации структуры на бэкенде при несовпадении колонок возвращать 400 с телом:
* **Response (ошибка структуры):**
```json
{
  "detail": "Column structure mismatch",
  "expected_columns": ["cadastral_number", "area", "entrance", "floor", "premise_type", "premise_number"],
  "detected_columns": ["cadastral_number", "area", "entrance", "floor"]
}
```
Клиент отображает сравнение «Обнаруженные колонки» vs «Ожидаемые колонки» на основе полей `detected_columns` и `expected_columns`.

### 7. Нефункциональные требования
* **UX:** Инструкция должна быть видимой до выбора файла; сообщение об ошибке структуры — читаемым и без технического жаргона где возможно.
* **Accessibility:** Элемент выбора файла доступен с клавиатуры и с мобильных устройств.

**Приоритет:** Повышен в связи с блокирующей ролью загрузки реестров для навигации и аналитики; реализация в связке с CORE-01.

---

### 8. Реализация (Implementation)

| Компонент | Расположение |
|-----------|--------------|
| Нормализация номера помещения (SR-CORE01-018..023) | [backend/app/room_normalizer.py](../../backend/app/room_normalizer.py) |
| Парсинг CSV/XLS/XLSX, валидация, импорт в БД (CORE-01) | [backend/app/import_register.py](../../backend/app/import_register.py) |
| API POST /api/admin/import/register | [backend/app/routers/import_register.py](../../backend/app/routers/import_register.py) |
| Страница загрузки (LOST-02) | [frontend/src/pages/Upload.jsx](../../frontend/src/pages/Upload.jsx) |
| Документация развёртывания | [docs/deploy/04-import-chain.md](../deploy/04-import-chain.md) |
