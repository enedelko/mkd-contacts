# ADM-02, ADM-05 — Модерация и аудит суперадмина

Модуль SRS: требования к интерфейсу модерации контактов (ADM-02) и к логированию действий суперадмина (ADM-05). Зависимости: BE-03, ADM-01, ADM-04.

---

## ADM-02 — Интерфейс модерации: таблица, фильтры IP/TimeRange, пакетный перевод в «Неактуальные»

**Согласование с CORE-03 (07):** экран со списком контактов один — «Ручной аудит контактов» (CORE-03). Список показывается только после выбора подъезда (SR-CORE03-004). Фильтры ADM-02 (IP, диапазон дат) применяются на этом же экране после выбора подъезда как дополнительные к подъезду, номеру помещения и статусу.

### 1. Архитектурный анализ (CoT)
Реализуется на Frontend (React) + Backend: страница для администратора с таблицей записей контактов, фильтрами по IP и диапазону дат, действием «перевести выбранные в Неактуальные». Backend предоставляет GET с фильтрами и PATCH для пакетного обновления статуса. Аудит (BE-03) фиксирует массовые действия. Логика входа на экран и отображения списка — по CORE-03 (сначала подъезд).

### 2. Описание и цель
Интерфейс для пакетной модерации записей: просмотр с фильтрами и массовый перевод в «Неактуальные» для защиты от спама. Цель — БТ [cite: 72, 74].

### 3. Функциональные требования
* **SR-ADM02-001:** Система должна предоставлять API для получения списка записей контактов с фильтрами: IP-адрес (или маска), диапазон дат (TimeRange). На UI список отображается только после выбора подъезда (CORE-03); фильтры IP и TimeRange — дополнительные к подъезду.
* **SR-ADM02-002:** Система должна возвращать в списке только метаданные и обезличенные идентификаторы (не расшифрованные контакты в списке по умолчанию — или по политике доступа с аудитом чтения).
* **SR-ADM02-003:** Система должна предоставлять API для пакетного перевода выбранных записей в статус «Неактуальные» (массив contact_id).
* **SR-ADM02-004:** Пакетное обновление должно выполняться в транзакции и записываться в аудит-лог (одна запись на действие «пакетная модерация» с перечнем id).
* **SR-ADM02-005:** Клиент должен отображать таблицу с выбранными фильтрами, чекбоксы выбора записей и кнопку «Перевести в Неактуальные».

### 4. Сценарий использования
**Триггер:** Администратор открывает раздел модерации (тот же экран, что и ручной аудит CORE-03).
**Main Success Scenario:**
1. Администратор выбирает подъезд (список появляется); при необходимости задаёт дополнительные фильтры (IP, даты, номер помещения), загружает/уточняет список, выбирает записи и нажимает «В Неактуальные».
2. Система обновляет статусы и возвращает успех; таблица обновляется.
**Alternative Flows:**
* **AF-1 (Нет выбранных записей):** Кнопка неактивна или возвращается ошибка «Выберите хотя бы одну запись».
* **AF-2 (Таймаут при большом выборе):** Ограничить размер пакета (например, до 500 id); при превышении — разбить на батчи или предупреждение.

### 5. Модель данных
Используется модель контакта (статус). Аудит — запись о пакетном действии.

### 6. Интеграции и API
* **Method:** `GET /api/admin/contacts?entrance=&ip=&from=&to=&premises_number=&status=&page=&size=`
* **Параметры:** entrance — обязателен (CORE-03); ip, from, to, premises_number, status — опциональные фильтры.
* **Response:** Список с contact_id, premise_id, ip, created_at, status (без расшифрованных ПДн в списке или с ограничением прав).
* **Method:** `POST /api/admin/contacts/bulk-status`
* **Request:**
```json
{
  "contact_ids": ["uuid1", "uuid2"],
  "status": "inactive"
}
```

### 7. Нефункциональные требования
* **Security:** Только роль administrator/super_administrator; аудит всех пакетных действий.
* **Performance:** Пагинация и лимит размера ответа; индексы по ip, created_at.

---

## ADM-05 — Логирование действий суперадмина

### 1. Архитектурный анализ (CoT)
Расширение аудит-лога (BE-03): все действия суперадмина (добавление/удаление админов, возможно другие) записываются в тот же механизм аудита с пометкой роли и сущности.

### 2. Описание и цель
Аудит действий суперадмина для подотчётности и расследования инцидентов.

### 3. Функциональные требования
* **SR-ADM05-001:** Система должна записывать в аудит-лог каждое добавление записи в таблицу admins (кто добавил, кого, когда).
* **SR-ADM05-002:** Система должна записывать в аудит-лог каждое удаление записи из таблицы admins (кто удалил, кого, когда).
* **SR-ADM05-003:** Запись лога должна содержать: идентификатор суперадмина (telegram_id или user_id), действие, целевой telegram_id, IP, метку времени.
* **SR-ADM05-004:** Просмотр логов суперадминских действий должен быть доступен только суперадмину (или отдельный экспорт для комплаенса).
* **SR-ADM05-005:** Смена пароля администратором (для себя через POST /api/auth/change-password) и установка/смена пароля суперадмином (при добавлении админа или PATCH) должны записываться в audit_log с action=password_change; в лог не попадают сами пароли (см. ADM-01-PWD, 09-admin-login-password.md).

### 4. Сценарий использования
**Триггер:** Суперадмин выполняет добавление или удаление администратора (ADM-04).
**Main Success Scenario:**
1. Суперадмин вызывает POST/DELETE админов.
2. После успешного выполнения система записывает событие в audit_log.
**Alternative Flows:**
* **AF-1 (Сбой записи лога):** По политике BE-03 — не блокировать основную операцию; fallback в файл при недоступности БД логов.

### 5. Модель данных
Используется таблица audit_log; entity_type = "admins", operation = ADD/REMOVE.

### 6. Интеграции и API
Внутренняя реализация; API просмотра логов — фильтр по entity_type и role.

### 7. Нефункциональные требования
* **Retention:** Политика хранения логов суперадмина не короче общего аудита (документировать).
