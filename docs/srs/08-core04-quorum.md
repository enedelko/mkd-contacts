# CORE-04 — Математика кворума: базовый расчёт долей (API)

### 1. Архитектурный анализ (CoT)
Реализуется в Logic Module: расчёт отношения площади помещений с голосами «ЗА» (всех, без требования валидации) к общей площади дома. Данные по площадям и голосам берутся из PostgreSQL. Результат отдаётся по API для отображения на фронте и в отчётах.

### 2. Описание и цель
Базовый прогноз кворума: доля площади с голосами «ЗА» от общей площади МКД. Цель — дать пользователю и админу показатель приближения к 2/3.

### 3. Функциональные требования
* **SR-CORE04-001:** Система должна вычислять общую площадь всех помещений МКД (по реестру помещений).
* **SR-CORE04-002:** Система должна вычислять сумму площадей помещений, по которым есть хотя бы одна запись голосования с позицией «ЗА» (голосование_в_ОСС.позиция_за = true), без требования валидированности контакта.
* **SR-CORE04-003:** Система должна возвращать отношение (площадь «ЗА» / общая площадь) в виде числа (доля или процент) и при необходимости порог 2/3 (кворум достигнут да/нет).
* **SR-CORE04-004:** Система должна предоставлять API для получения этого расчёта по идентификатору дома/объекта.
* **SR-CORE04-005:** При отсутствии данных по помещению (нет реестра) система должна возвращать явное состояние «нет данных» или нули.
* **SR-CORE04-006:** Система должна отображать на главной странице текущий расчёт кворума (доля площади «ЗА», порог 2/3, достигнут/не достигнут) для всех посетителей, в т.ч. неавторизованных (обезличенная статистика по БРД 2.1).
* **SR-CORE04-007:** Система должна вычислять и возвращать в ответе API кворума долю площади помещений, по которым есть хотя бы один контакт (со статусом pending или validated), зарегистрированный в Электронном доме (`contacts.registered_in_ed = 'yes'`): сумма площадей таких помещений / общая площадь. Цель — показатель «% жителей в Электронном доме» по дому в целом (аналогично расчёту кворума, без порога).

### 4. Сценарий использования
**Триггер:** Запрос страницы объекта или отчёта с прогнозом кворума.
**Main Success Scenario:**
1. Клиент запрашивает расчёт кворума по building_id.
2. Сервер считает площади и долю «ЗА», возвращает результат.
**Alternative Flows:**
* **AF-1 (Нет помещений):** Возврат 0/0 и флаг «нет данных».
* **AF-2 (Делитель ноль):** Избегать деления на ноль; возвращать 0 или «нет данных».

### 5. Модель данных
Используются: помещения (площадь), контакты и голосование_в_ОСС (позиция_за, связь контакт → помещение). Общая площадь дома — сумма площадей помещений или отдельное поле в справочнике дома.

### 6. Интеграции и API
* **Method:** `GET /api/buildings/{building_id}/quorum`
* **building_id:** префикс кадастрового номера (напр. `77:01:0001001`) или `default` — расчёт по всем помещениям в БД (режим «один дом на инстанс»).
* **Response:**
```json
{
  "total_area": 4500.5,
  "area_voted_for": 1200.0,
  "ratio": 0.266,
  "quorum_threshold": 0.667,
  "quorum_reached": false,
  "area_registered_ed": 800.0,
  "ed_ratio": 0.178
}
```
Поля `area_registered_ed` и `ed_ratio` (SR-CORE04-007): площадь помещений с хотя бы одним контактом в ЭД и доля от общей площади.

### 7. Нефункциональные требования
* **Performance:** Расчёт должен выполняться за приемлемое время (индексы по помещению, голосам); при большом объёме — кеш на короткий TTL.

---

### 8. Реализация (Implementation)

| Компонент | Расположение | Статус |
|-----------|--------------|--------|
| API GET /api/buildings/{building_id}/quorum | [backend/app/routers/quorum.py](../../backend/app/routers/quorum.py) | ✅ |
| Отображение кворума на главной (SR-CORE04-006) | [frontend/src/App.jsx](../../frontend/src/App.jsx) — компонент Home | ✅ |
