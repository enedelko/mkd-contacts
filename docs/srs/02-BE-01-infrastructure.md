# BE-01 — Инфраструктура: Развертывание в РФ-контуре

### 1. Архитектурный анализ (CoT)
Фича реализуется на уровне инфраструктуры из arch.md: три сервиса Docker (frontend, backend, db) и Nginx на хосте в качестве единственной точки входа. Требуется размещение в РФ (данные не покидают территорию) и RTO &lt; 24ч за счёт контейнеризации и процедур восстановления.

### 2. Описание и цель
Техническое развертывание приложения в российском контуре: Docker Compose (frontend, backend, db) и Nginx на хост-машине перед контейнерами. Публичный доступ — только через хостовой Nginx; порты контейнеров привязаны к localhost и недоступны извне. Цель — выполнение требований 152-ФЗ по локализации данных, изоляция контейнеров и восстановление в течение 24 часов.

### 3. Функциональные требования
* **SR-BE01-001:** Система должна разворачиваться как набор контейнеров: `frontend`, `backend`, `db`.
* **SR-BE01-002:** Сервис `db` должен использовать официальный образ PostgreSQL с персистентными томами.
* **SR-BE01-003:** Сервис `backend` должен запускаться под управлением Uvicorn/Gunicorn.
* **SR-BE01-004:** Сервис `frontend` должен отдавать статический бандл React через Nginx внутри контейнера.
* **SR-BE01-005:** Документация/скрипты развертывания должны допускать размещение всех сервисов на площадке в РФ (без явного выноса данных за границу).
* **SR-BE01-006:** Перед контейнерами должен работать Nginx на хост-машине как единственная публичная точка входа (порты 80/443).
* **SR-BE01-007:** Порты контейнеров (frontend, backend) должны быть привязаны только к localhost (127.0.0.1) и не публиковаться наружу; доступ к ним — только с хост-машины (в т.ч. со стороны хостового Nginx).

### 4. Сценарий использования
**Триггер:** Необходимость развернуть или восстановить стенд.
**Main Success Scenario:**
1. Оператор настраивает Nginx на хосте (конфиг-пример в docs/deploy), запускает `docker compose up -d`.
2. Система поднимает три контейнера; порты frontend и backend слушают только на 127.0.0.1. Внешний трафик принимает хостовой Nginx и проксирует на localhost.
**Alternative Flows:**
* **AF-1 (Сбой образа):** Если образ недоступен, система логирует ошибку; оператор использует локально собранные образы.
* **AF-2 (Порт занят):** Если порт на хосте занят (80/443 или localhost:8080/8000), оператор правит конфиг Nginx и при необходимости маппинг в docker-compose.yml.

**Проверка занятых портов (перед запуском или при AF-2):**
* **Linux:** `ss -tlnp | grep -E ':80|:443|:8000|:8080'` или `netstat -tlnp | grep -E ':80|:443|:8000|:8080'` — показать процессы, слушающие 80, 443, 8000, 8080. Для проверки только localhost: `ss -tlnp | grep '127.0.0.1'`.
* **Windows (PowerShell):** `Get-NetTCPConnection -State Listen | Where-Object { $_.LocalPort -in 80,443,8000,8080 }` — список слушающих портов; процесс по PID: `Get-Process -Id <PID>`.

### 5. Модель данных
Не применимо (инфраструктура).

### 6. Интеграции и API
Не применимо.

### 7. Нефункциональные требования
* **Security:** Конфигурация не должна содержать мастер-ключи шифрования в репозитории; ключ подаётся в контейнер бэкенда исключительно через Docker Secrets или bind mount (см. BE-02). **Архитектурная изоляция:** секрет с мастер-ключом пробрасывается ИСКЛЮЧИТЕЛЬНО в контейнер Backend. Контейнер Database (PostgreSQL) физически не должен иметь доступа к этому секрету или к директории с ключами шифрования.
* **Performance:** Старт всех контейнеров — в пределах разумного времени (ориентир &lt; 2 мин на типовом железе).

### 8. Реализация (Implementation)

| Компонент | Расположение |
|-----------|--------------|
| Docker Compose (frontend, backend, db) | [docker-compose.yml](../../docker-compose.yml) |
| Nginx на хосте (пример конфига) | [docs/deploy/nginx-host.example.conf](../deploy/nginx-host.example.conf) |
| Backend (FastAPI, Uvicorn) | [backend/](../../backend/) |
| Frontend (React/Vite, Nginx в контейнере) | [frontend/](../../frontend/) |
| Документация развёртывания (РФ, секреты, хост Nginx) | [docs/deploy/01-bootstrap.md](../deploy/01-bootstrap.md) |
