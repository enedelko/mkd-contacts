# ADM-01-PWD — Вход по логину/паролю и смена пароля

**Версия:** 1.0  
**Дата:** 2026-02-13  
**Связь с ADM-01:** альтернативный способ авторизации администратора (когда Telegram OAuth недоступен или неудобен).

---

## 1. Описание и цель

Доработка добавляет возможность входа в админ-панель по логину и паролю в дополнение к входу через Telegram OAuth. Цель — обеспечить резервный канал авторизации при сбоях или ограничениях Telegram и дать администратору возможность самостоятельно сменить пароль.

---

## 2. Функциональные требования

* **SR-ADM01-PWD-001:** Система должна предоставлять эндпоинт входа по логину и паролю, возвращающий JWT в том же формате, что и при входе через Telegram (access_token, token_type, role).
* **SR-ADM01-PWD-002:** Логин и хеш пароля должны храниться в таблице `admins` (поля `login`, `password_hash`). Пароль хранится только в виде bcrypt-хеша (passlib).
* **SR-ADM01-PWD-003:** Логин должен быть уникальным в рамках таблицы `admins`; при поиске по логину применяется нормализация (trim, lower case).
* **SR-ADM01-PWD-004:** При успешной проверке логина и пароля система выдаёт JWT с `sub`, равным `telegram_id` соответствующей записи в `admins` (единый идентификатор для аудита и прав).
* **SR-ADM01-PWD-005:** Система должна предоставлять эндпоинт смены пароля для текущего авторизованного администратора по предъявлению текущего пароля и нового пароля (не короче 8 символов).
* **SR-ADM01-PWD-006:** Установка и изменение логина/пароля для произвольного админа доступна только суперадмину (расширение API ADM-04: опциональные login/password при добавлении админа и PATCH для существующего).
* **SR-ADM01-PWD-007:** Клиент должен отображать на странице входа форму «Логин» + «Пароль» и кнопку «Войти по логину и паролю», а также (при настроенном боте) кнопку «Войти через Telegram».
* **SR-ADM01-PWD-008:** Клиент должен предоставлять страницу «Смена пароля» (поля: текущий пароль, новый пароль, подтверждение) и ссылку на неё в навигации для авторизованного пользователя.

---

## 3. Модель данных

**Изменения в таблице `admins` (миграция 005):**

| Поле           | Тип           | Описание |
|----------------|---------------|----------|
| `login`        | VARCHAR(64)   | Уникальный логин для входа (nullable). |
| `password_hash`| VARCHAR(255)  | Bcrypt-хеш пароля (nullable). |

Существующие поля `telegram_id`, `role`, `created_at` без изменений. Администратор может иметь только Telegram, только логин/пароль (при этом `telegram_id` может быть синтетическим, например `pwd:loginname`), или оба способа.

---

## 4. Интеграции и API

### Вход по логину и паролю

* **Method:** `POST /api/auth/login`
* **Body:** `{ "login": "string", "password": "string" }`
* **Response (успех):** `200 OK`, `{ "access_token": "...", "token_type": "bearer", "role": "administrator" | "super_administrator" }`
* **Response (ошибка):** `401` — «Неверный логин или пароль»; `400` — «Укажите логин».

### Смена пароля

* **Method:** `POST /api/auth/change-password`
* **Headers:** `Authorization: Bearer <JWT>`
* **Body:** `{ "current_password": "string", "new_password": "string" }`
* **Response (успех):** `204 No Content`
* **Response (ошибка):** `400` — неверный текущий пароль, пароль не задан (обратиться к суперадмину), новый пароль короче 8 символов; `401` — не авторизован; `403` — запись админа не найдена.

### Управление логином/паролем (суперадмин)

* **Method:** `PATCH /api/superadmin/admins/{telegram_id}`
* **Headers:** `Authorization: Bearer <JWT>` (super_administrator)
* **Body:** `{ "login": "string" | null, "password": "string" | null }` — установка или смена логина и/или пароля; пароль — не короче 8 символов.
* **Расширение POST /api/superadmin/admins:** в теле опционально можно передать `"login"` и `"password"` при добавлении нового админа.

* **Расширение GET /api/superadmin/admins:** в каждой записи добавлено поле `has_login: boolean` (наличие логина у админа, без раскрытия самого логина).

---

## 5. Сценарии использования

**Вход по логину/паролю:** Пользователь открывает страницу входа, вводит логин и пароль, нажимает «Войти по логину и паролю». При успехе получает JWT и перенаправляется на главную. При ошибке — сообщение «Неверный логин или пароль».

**Смена пароля:** Авторизованный админ переходит по ссылке «Смена пароля», вводит текущий пароль, новый пароль и подтверждение. При успехе — сообщение «Пароль успешно изменён». Если пароль не был задан ранее — сообщение с просьбой обратиться к суперадмину.

**Установка логина/пароля суперадмином:** Суперадмин вызывает `PATCH /api/superadmin/admins/{telegram_id}` с нужными полями или задаёт login/password при `POST /api/superadmin/admins` при добавлении админа.

---

## 6. Реализация (Implementation)

| Компонент | Расположение |
|-----------|--------------|
| Миграция 005 (login, password_hash) | [backend/alembic/versions/005_admins_login_password.py](../../backend/alembic/versions/005_admins_login_password.py) |
| Хеширование и проверка пароля | [backend/app/auth_password.py](../../backend/app/auth_password.py) |
| Эндпоинты login, change-password | [backend/app/routers/auth.py](../../backend/app/routers/auth.py) |
| PATCH/POST расширения (суперадмин) | [backend/app/routers/superadmin.py](../../backend/app/routers/superadmin.py) |
| Страница входа (форма + Telegram) | [frontend/src/pages/Login.jsx](../../frontend/src/pages/Login.jsx) |
| Страница смены пароля | [frontend/src/pages/ChangePassword.jsx](../../frontend/src/pages/ChangePassword.jsx) |
| Зависимость passlib[bcrypt] | [backend/requirements.txt](../../backend/requirements.txt) |
| Скрипт установки логина/пароля (суперадмин, по API) | [scripts/set-admin-login-password.sh](../../scripts/set-admin-login-password.sh) |
| Скрипт первичной установки (bootstrap, без JWT) | [scripts/set-admin-login-password-bootstrap.sh](../../scripts/set-admin-login-password-bootstrap.sh) |

---

## 7. Зависимости и трассируемость

* Зависит от ADM-01 (JWT, белый список), ADM-04 (управление админами).
* Требование к длине пароля (не менее 8 символов) — нефункциональное ограничение безопасности.
