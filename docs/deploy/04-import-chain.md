# CORE-01, LOST-02 — Импорт реестра и страница загрузки

Инструкции по импорту реестра помещений и контактов и по странице загрузки ([04-import-chain.md](../srs/04-import-chain.md)).

---

## 1. CORE-01 — API импорта

### 1.1. Эндпоинт

- **POST** `/api/admin/import/register`
- **Тип запроса:** `multipart/form-data`, поле `file` (CSV, XLS или XLSX).
- **Авторизация:** заголовок `Authorization: Bearer <JWT>`. Доступ только для роли **administrator** или **super_administrator** (SR-CORE01-001).

### 1.2. Успешный ответ

После обработки всех валидных строк возвращается отчёт:

```json
{
  "accepted": 120,
  "rejected": 3,
  "errors": [
    { "row": 5, "message": "Missing required field: cadastral_number" },
    { "row": 18, "message": "Collision: phone matches existing contact, email contradicts" }
  ]
}
```

### 1.3. Ошибка структуры (LOST-02)

При несовпадении набора колонок (в т.ч. отсутствие обязательной колонки кадастрового номера) — **400** с телом:

```json
{
  "detail": "Column structure mismatch",
  "expected_columns": ["cadastral_number", "area", "entrance", ...],
  "detected_columns": ["заголовки из файла"]
}
```

Клиент отображает сравнение «Обнаруженные колонки» и «Ожидаемые колонки».

### 1.4. Ограничения

- Рекомендуемый размер файла — до 5 MB (настраивается на бэкенде).
- Кодировка CSV — UTF-8; разделитель — точка с запятой.
- ПДн шифруются перед записью (BE-02); сопоставление контактов — по Blind Index.

---

## 2. LOST-02 — Страница загрузки

- Маршрут: **/upload** (в админ-интерфейсе).
- На странице: инструкция по форматам (.csv, .xlsx, .xls) и список ожидаемых колонок; выбор файла (ПК и мобильные); после отправки — отчёт (accepted, rejected, errors) или сообщение об ошибке структуры с сравнением колонок.
- Для запроса к API необходим JWT (например, сохранённый после входа через Telegram).

---

## 3. Ожидаемые колонки файла

| Категория   | Колонки | Обязательность |
|------------|---------|----------------|
| Помещение  | cadastral_number | **Обязательно** |
| Помещение  | area, entrance, floor, premises_type, premises_number | Опционально |
| Контакт    | phone, email, telegram_id | Полностью опциональны (колонки могут отсутствовать). Если заполнено хотя бы одно — создаётся контакт; иначе — только помещение |
| Контакт    | how_to_address | Опционально |

Поддерживаются синонимы заголовков (например, «кадастровый_номер», «телефон», «площадь»). Номер помещения нормализуется по правилам SR-CORE01-018–023 (префиксы, кириллица→латиница, римские числа и т.д.).
