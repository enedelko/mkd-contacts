# 01 — Bootstrap и развёртывание (РФ-контур)

Документация по развёртыванию трёх сервисов (frontend, backend, db) в соответствии с [02-BE-01-infrastructure.md](../srs/02-BE-01-infrastructure.md).

---

## ⚠️ Продакшен: запрет дефолтных учётных данных

**В продакшене запрещён запуск без преднастроенного `.env` с уникальными секретами.**

В `docker-compose.yml` указаны значения по умолчанию (в т.ч. `POSTGRES_PASSWORD:-mkd_secret`) **только для локальной разработки и проверки сборки**. Использование этих дефолтов в production недопустимо: пароль БД и иные секреты будут известны из репозитория и уязвимы.

**Обязательно перед запуском в production:**

1. Создать файл `.env` на сервере (не коммитить в репозиторий).
2. Задать **уникальный надёжный пароль** `POSTGRES_PASSWORD` (и при необходимости `POSTGRES_USER`, `POSTGRES_DB`).
3. Задать `JWT_SECRET`, `TELEGRAM_BOT_TOKEN`, `BLIND_INDEX_PEPPER` и обеспечить подачу мастер-ключа шифрования (BE-02) через файл/Secrets.

Без преднастроенного `.env` с уникальными значениями развёртывание в production выполнять **нельзя**.

---

## 1. Требования

- Docker и Docker Compose на хосте в **Российской Федерации** (данные не покидают территорию, 152-ФЗ).
- **Nginx на хост-машине** — единственная публичная точка входа (SR-BE01-006). Порты 80 (и при необходимости 443 для HTTPS) слушает только хостовой Nginx.
- Порты контейнеров привязаны к **localhost** (SR-BE01-007): frontend — 127.0.0.1:8080, backend — 127.0.0.1:8000; извне к ним обратиться нельзя. Доступ — только со стороны хостового Nginx. Порты 5432 (db) не публикуются, только внутренняя сеть Docker.

---

## 2. Быстрый старт

```bash
# Клонировать репозиторий на сервер в РФ (подставьте URL вашего репозитория)
git clone https://github.com/enedelko/mkd-contacts.git mkd-contacts && cd mkd-contacts

# Создать .env из примера и задать уникальные секреты (в production — обязательно)
cp .env.example .env
# Отредактировать .env: POSTGRES_PASSWORD (обязательно сменить!), POSTGRES_USER, POSTGRES_DB, JWT_SECRET и др.

# Настроить Nginx на хосте (пример конфига — nginx-host.example.conf в этой папке)
# Скопировать в /etc/nginx/sites-available/, включить сайт, перезагрузить nginx.

# Запуск контейнеров (SR-BE01-001)
docker compose up -d

# Проверка (через хостовой Nginx — после настройки)
docker compose ps
curl -s http://localhost/ | head -5
curl -s http://localhost/api/health
# Локально без Nginx (только для отладки): curl -s http://127.0.0.1:8080/ и http://127.0.0.1:8000/health
```

Ожидаемое время старта всех контейнеров — до 2 минут на типовом железе (NFR Performance).

---

## 3. Сервисы

| Компонент | Описание |
|-----------|----------|
| **Nginx (хост)** | Слушает 80/443, проксирует `/` → 127.0.0.1:8080, `/api/` → 127.0.0.1:8000. Пример: [nginx-host.example.conf](nginx-host.example.conf). |
| **db** | postgres:15-alpine, персистентный том pgdata. Порт 5432 только во внутренней сети Docker. |
| **backend** | FastAPI под Uvicorn. Публикуется только 127.0.0.1:8000 (доступен только хостовому Nginx). |
| **frontend** | Nginx в контейнере + статический бандл React. Публикуется только 127.0.0.1:8080 (доступен только хостовому Nginx). |

---

## 4. Размещение в РФ (SR-BE01-005)

- Запускать `docker compose` **только на площадке в РФ** (VPS/сервер с юрисдикцией РФ).
- Не использовать образы или реестры, требующие передачи данных за границу в процессе деплоя (при необходимости — предсобранные образы на том же хосте).
- При сбое образа (AF-1): собрать образы локально на сервере:  
  `docker compose build --no-cache` затем `docker compose up -d`.

---

## 5. Секреты и безопасность (BE-02)

- **В репозитории не должно быть мастер-ключей шифрования.** Конфигурация не содержит ключей.
- Ключ подаётся в контейнер **только backend** одним из способов:
  - **Docker Secrets** (режим Swarm): создать секрет и подключить к сервису backend.
  - **Bind mount**: примонтировать файл с ключом в read-only в контейнер backend, например  
    `-v /secure/encryption.key:/app/encryption.key:ro`
- Контейнер **db** (PostgreSQL) **не должен** иметь доступа к секрету или к директории с ключами шифрования (архитектурная изоляция).

---

## 6. Хостовой Nginx (SR-BE01-006, SR-BE01-007)

- Установка: `apt install nginx` (или аналог). Пример конфигурации — [nginx-host.example.conf](nginx-host.example.conf).
- Конфиг разместить в `/etc/nginx/sites-available/mkd-contacts`, создать симлинк в `sites-enabled`, проверить `nginx -t`, перезагрузить `systemctl reload nginx`.
- Публичный доступ к приложению — только через этот Nginx. Порты 8080 и 8000 на localhost снаружи недоступны.

## 7. Проблемы (Alternative Flows)

- **AF-1 (образ недоступен):** логировать ошибку, собрать образы локально (`docker compose build`).
- **AF-2 (порт занят):** если заняты 80/443 — править конфиг хостового Nginx; если 127.0.0.1:8080 или 127.0.0.1:8000 — изменить маппинг в `docker-compose.yml` и соответствующие `proxy_pass` в nginx-host конфиге.

---

## 8. Восстановление (RTO &lt; 24 ч)

- Данные БД хранятся в томе `pgdata`; при пересоздании контейнеров том сохраняется.
- Регулярное резервное копирование тома/дампа PostgreSQL и процедуры восстановления оформить отдельно (OPS, бэклог).
