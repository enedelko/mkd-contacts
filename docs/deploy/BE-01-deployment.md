# BE-01 — Развёртывание инфраструктуры (РФ-контур)

Документация по развёртыванию трёх сервисов (frontend, backend, db) в соответствии с [02-BE-01-infrastructure.md](../srs/02-BE-01-infrastructure.md).

---

## ⚠️ Продакшен: запрет дефолтных учётных данных

**В продакшене запрещён запуск без преднастроенного `.env` с уникальными секретами.**

В `docker-compose.yml` указаны значения по умолчанию (в т.ч. `POSTGRES_PASSWORD:-mkd_secret`) **только для локальной разработки и проверки сборки**. Использование этих дефолтов в production недопустимо: пароль БД и иные секреты будут известны из репозитория и уязвимы.

**Обязательно перед запуском в production:**

1. Создать файл `.env` на сервере (не коммитить в репозиторий).
2. Задать **уникальный надёжный пароль** `POSTGRES_PASSWORD` (и при необходимости `POSTGRES_USER`, `POSTGRES_DB`).
3. Задать `JWT_SECRET`, `TELEGRAM_BOT_TOKEN`, `BLIND_INDEX_PEPPER` и обеспечить подачу мастер-ключа шифрования (BE-02) через файл/Secrets.

Без преднастроенного `.env` с уникальными значениями развёртывание в production выполнять **нельзя**.

---

## 1. Требования

- Docker и Docker Compose на хосте в **Российской Федерации** (данные не покидают территорию, 152-ФЗ).
- Порты: 80 (frontend), 8000 (backend), 5432 (внутри сети, не публикуется).

---

## 2. Быстрый старт

```bash
# Клонировать репозиторий на сервер в РФ
git clone <repo> mkd-contacts && cd mkd-contacts

# Создать .env из примера и задать уникальные секреты (в production — обязательно)
cp .env.example .env
# Отредактировать .env: POSTGRES_PASSWORD (обязательно сменить!), POSTGRES_USER, POSTGRES_DB, JWT_SECRET и др.

# Запуск (SR-BE01-001, сценарий Main Success)
docker compose up -d

# Проверка
docker compose ps
curl -s http://localhost/ | head -5
curl -s http://localhost:8000/health
```

Ожидаемое время старта всех контейнеров — до 2 минут на типовом железе (NFR Performance).

---

## 3. Сервисы

| Сервис    | Образ/сборка      | Назначение                          |
|-----------|-------------------|-------------------------------------|
| **db**    | postgres:15-alpine| PostgreSQL, персистентный том pgdata|
| **backend** | backend/Dockerfile | FastAPI под Uvicorn, порт 8000    |
| **frontend** | frontend/Dockerfile | Nginx + статический бандл React, порт 80 |

---

## 4. Размещение в РФ (SR-BE01-005)

- Запускать `docker compose` **только на площадке в РФ** (VPS/сервер с юрисдикцией РФ).
- Не использовать образы или реестры, требующие передачи данных за границу в процессе деплоя (при необходимости — предсобранные образы на том же хосте).
- При сбое образа (AF-1): собрать образы локально на сервере:  
  `docker compose build --no-cache` затем `docker compose up -d`.

---

## 5. Секреты и безопасность (BE-02)

- **В репозитории не должно быть мастер-ключей шифрования.** Конфигурация не содержит ключей.
- Ключ подаётся в контейнер **только backend** одним из способов:
  - **Docker Secrets** (режим Swarm): создать секрет и подключить к сервису backend.
  - **Bind mount**: примонтировать файл с ключом в read-only в контейнер backend, например  
    `-v /secure/encryption.key:/app/encryption.key:ro`
- Контейнер **db** (PostgreSQL) **не должен** иметь доступа к секрету или к директории с ключами шифрования (архитектурная изоляция).

---

## 6. Проблемы (Alternative Flows)

- **AF-1 (образ недоступен):** логировать ошибку, собрать образы локально (`docker compose build`).
- **AF-2 (порт занят):** изменить маппинг в `docker-compose.yml` (например, `"8080:80"` для frontend).

---

## 7. Восстановление (RTO &lt; 24 ч)

- Данные БД хранятся в томе `pgdata`; при пересоздании контейнеров том сохраняется.
- Регулярное резервное копирование тома/дампа PostgreSQL и процедуры восстановления оформить отдельно (OPS, бэклог).
