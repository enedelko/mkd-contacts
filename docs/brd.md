# Бизнес-требования (БТ): Приложение "Кворум-МКД" (v2.3) 

## 1. Общие сведения
* **Цель проекта**: Создание цифрового инструмента для сбора контактов и прогнозирования итогов Общего собрания собственников (ОСС).
* **Ключевой показатель (KPI)**: Достижение кворума в 2/3 голосов от общей площади помещений МКД.
* **Правовой статус данных**: Система обрабатывает ПДн в соответствии с 152-ФЗ. Операторы — физические лица (Инициативная группа).
* **Принцип минимизации**: ФИО не хранятся.

---

## 2. Роли и права доступа
### 2.1. Пользователь (Публичный доступ)
* **Доступ**: По прямой ссылке.
* **Функции**: Поиск помещения (карта/список), просмотр обезличенной статистики по объекту, заполнение анкеты, запрос на удаление своих данных.

### 2.2. Администратор (Авторизованный доступ)
* **Доступ**: Telegram OAuth или логин/пароль (белый список).
* **Согласие с Политикой конфиденциальности**: При первом входе администратор обязан принять ответственность за сохранность и законность обработки персональных данных в соответствии с Политикой конфиденциальности (152-ФЗ). До принятия согласия доступ к админ-функциям запрещён; факт и версия согласия фиксируются в БД и в аудит-логе.
* **Функции**: Валидация, пакетная модерация, импорт реестра, выгрузка отчетов, просмотр логов (включая логи чтения).

### 2.3. Супер-администратор
* **Доступ**: Telegram OAuth или логин/пароль (белый список).
* **Согласие с Политикой конфиденциальности**: То же, что для Администратора (обязательное принятие при первом входе).
* **Функции**: Добавление/удаление Администраторов.

---

## 3. Функциональные требования
### 3.1. Навигация и поиск помещения
Система обеспечивает два способа выбора объекта:

**1. Интерактивная SVG-карта**:
* Реализуется на основе векторной графики, встраиваемой в DOM.
* Объекты содержат `id`, соответствующий кадастровому номеру в БД.
* **UX сценарий**:
    1.  **Мастер-план**: Общий вид МКД (выбор подъезда или паркинга).
    2.  **Схема разреза**: Вертикальная проекция для выбора этажа.
    3.  **План этажа**: Детальная схема (выбор квартиры/машиноместа).
* Поддержка pinch-to-zoom и pan для паркинга и кладовок.

**2. Иерархические фильтры**:
* Каскадный поиск: Подъезд → Этаж → Тип помещения → Номер. [cite: 30, 31]
* Служит текстовой альтернативой карте для слабых устройств.

**Легенда состояний**:
* **Контур**: Данных нет.
* **Светло-желтый**: Есть контакты, но не валидированы.
* **Светло-зеленый**: Часть контактов валидирована.
* **Ярко-зеленый**: Все контакты валидированы.
* **Ярко-синяя рамка**: Текущий выбор пользователя.

### 3.2. Сбор данных и Анкета
При выборе объекта заполняется форма:
* Чек-бокс "Я собственник".
* Контакт (Телефон, Telegram и/или Email).
* Позиция по ОСС ("ЗА" Да/Нет) и формат (Бумага/Электронно).
* Чек-бокс "Зарегистрирован в Электронном Доме".
* **Согласие на ОПД**: Обязательные чек-боксы и ссылка на Политику. [cite: 46, 48]
* **Защита**: Капча; лимит до 10 невалидированных записей. [cite: 50, 51]

### 3.3. Система рекомендаций (Кросс-объекты)
* **Память сессии**: Сохранение данных в `sessionStorage` для автозаполнения.
* **Nudge**: Модальное окно после сохранения первой анкеты с предложением выбрать другие помещения (машиноместо/кладовку). [cite: 56, 57]

### 3.5. Аналитика и расчет кворума
* **Базовый прогноз**: Отношение площади с голосами "ЗА" (всех) к общей площади дома.
* **Сложный расчет**: Отношение площади, где *все* валидированные собственники "ЗА", к общей площади.

### 3.6. Администрирование и Модерация
* **Импорт**: Загрузка CSV/XLS с данными помещений.
* **Пакетная модерация**: Массовое изменение статуса записей на "Неактуальные" (защита от спама). [cite: 72, 74]
* **Аудит**: Логирование всех действий (изменение, чтение, IP-адрес). [cite: 77, 78]
* **Согласие администратора с Политикой (152-ФЗ)**: При первом входе администратор и суперадминистратор обязаны на отдельной странице принять ответственность за сохранность ПДн в соответствии с Политикой конфиденциальности. Система фиксирует версию политики и дату/время согласия в БД; факт принятия записывается в аудит-лог. До принятия согласия все запросы к админ- и суперадмин-API возвращают отказ (403); клиент перенаправляет пользователя на страницу согласия.

---

## 4. Альтернативный канал (Telegram-бот)
* **Сценарий**: Линейный опрос (Conversational UI). [cite: 80, 81]
* **Поиск**: Текстовый ввод (например, "кв 45") с распознаванием типа объекта. [cite: 83, 84]
* **Авторизация**: Пользователи через ТГ могут редактировать свои данные и отзывать согласие. [cite: 92, 93]
* **Синхронизация**: Данные мгновенно попадают в общую БД и отображаются на SVG-картах.

---

## 5. Технические и нефункциональные требования
* **Безопасность**:
    * Локализация данных в РФ (152-ФЗ).
    * Шифрование контактов в БД (AES-256).
    * Rate Limiting: не более 10 записей в час с одного IP.
    * Хранение мастер-ключей отдельно от БД.
    * Обязательное согласие администратора с Политикой конфиденциальности при первом входе (фиксация версии и даты в БД, запись в аудит-лог); без согласия доступ к админ-функциям запрещён (403).
* **Актуализация данных**:
    * Если новый собственник валидирован спустя >90 дней после старого, старые данные уходят в архив. [cite: 119, 120]
    * В пределах 60 дней пользователи считаются сособственниками.
* **Отказоустойчивость**:
    * Ежедневные бэкапы (глубина 14 дней) на внешнее хранилище. [cite: 131, 133]
    * Использование Docker; восстановление (RTO) до 24 часов. [cite: 134, 135]
    * Graceful Degradation при недоступности БД.

---

## Приложение 1. Алгоритм распознавания интентов
1.  **Нормализация**: Нижний регистр, удаление пробелов, замена «ё» на «е». [cite: 140, 141, 143]
2.  **Проверка КН**: Поиск по регулярному выражению кадастрового номера. [cite: 144, 145]
3.  **Парсинг**: Выделение типа (квартира, мм, кладовка) и номера через словарь синонимов. [cite: 148, 149, 150]
4.  **Fuzzy Matching**: Использование расстояния Левенштейна для обработки опечаток (например, "мместо"). [cite: 180, 181]